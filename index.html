<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.7 ‚Äî KIWI TABS + ESTADO GLOBAL + SYNC</title>

<!-- Fonts + XLSX y Supabase -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  :root {
    --ink: #111827;
    --muted: #6b7280;
    --kiwi: #16a34a;
    --kiwi-2: #15803d;
    --border: #e5e7eb;
    --panel: #f8fafc;
    --bad: #dc2626;
    --ok: #16a34a;
    --warn: #f59e0b;
    --bg: #ffffff;
  }
  * { box-sizing: border-box; }
  body { font-family: 'Poppins', sans-serif; color: var(--ink); background: #fff; margin: 0; }
  h1 { font-size: 18px; margin: 0; color: var(--ink); }
  .container { padding: 12px 12px 80px; }
  .hint { font-size: 12px; color: var(--muted); }

  /* ... (C√≥digo CSS completo del tema visual) ... */

</style>
</head>

<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h1>üçà ARSLAN LISTAS v3.7 ‚Äî KIWI TABS + SYNC</h1>
      <span class="pill">Versi√≥n sincronizada manual</span>
    </div>

    <!-- ======= Estado Global Superior ======= -->
    <div id="global-status">
      <strong>üìä ESTADO GLOBAL DEL SISTEMA</strong>
      <span id="status-assign">üßæ Sin asignar: 0</span> &nbsp;&nbsp;
      <span id="status-buy">üõí Sin comprar: 0</span> &nbsp;&nbsp;
      <span id="status-sent">‚úÖ Pedidos enviados: 0</span><br>
      <span id="status-bought">üì¶ Comprados: 0 uds</span> &nbsp;&nbsp;
      <span id="status-distribute">üöö Reparto pendiente: 0</span> &nbsp;&nbsp;
      <span id="status-prices">üìä Cambios precio: 0</span>
    </div>

    <div class="hint" style="margin-bottom:10px">
      Flujo: Diccionario ‚Üí Tiendas (Estandarizar/Exportar) ‚Üí Global (Asignar) ‚Üí Proveedores (WhatsApp/TXT) ‚Üí Compras ‚Üí Reparto ‚Üí Precios
    </div>

    <!-- üîΩ AQUI EMPIEZAN LOS TABS (BLOQUE 2) -->
    <!-- ========== TAB: Diccionario ========== -->
    <section class="tab" id="tab-dic">
      <div class="card">
        <div class="hd">
          <strong>üìö Vocabulario estandarizado (editable)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
            <button class="btn ghost" onclick="saveVocab()">Guardar vocabulario</button>
            <button class="btn muted" onclick="resetAll()">üßπ Limpiar todo</button>
            <button class="btn muted" onclick="resetAllButKeepVocab()">‚ôªÔ∏è Reiniciar (mantener vocab)</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:6px">Un producto por l√≠nea. Se normaliza a <b>MAY√öSCULAS</b> sin tildes. Sin duplicados.</div>
          <textarea id="vocabTxt" placeholder="PEPINO&#10;TOMATE DANIELA&#10;AGUACATE GRANEL&#10;..."></textarea>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Tiendas ========== -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <!-- San Pablo -->
        <div class="card">
          <div class="hd">
            <strong>üè™ San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sp')">Guardar tienda</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">üìÑ TXT</button>
              <button class="btn ghost" onclick="whatsTienda('sp')">üü¢ WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo...&#10;Ej.: 3 cajas tomate daniela&#10;zanahoria 2&#10;aguacate granel 4"></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir.</div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- San Lesmes -->
        <div class="card">
          <div class="hd">
            <strong>üè™ San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sl')">Guardar tienda</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">üìÑ TXT</button>
              <button class="btn ghost" onclick="whatsTienda('sl')">üü¢ WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir.</div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Santiago -->
        <div class="card">
          <div class="hd">
            <strong>üè™ Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('st')">Guardar tienda</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">üìÑ TXT</button>
              <button class="btn ghost" onclick="whatsTienda('st')">üü¢ WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir.</div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Global ========== -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üßÆ Unificaci√≥n global</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal()">Unificar 3 tiendas</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">üìÑ TXT Global (asignados + pendientes)</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            ‚úÖ asigna al proveedor activo. Duplicados probables se <span class="red">marcan en rojo</span> y fila rosada (<b>‚ö†Ô∏è</b>).
          </div>
          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="hint">Proveedor activo:</span>
                <div class="prov-bar" id="provBar"></div>
              </div>
            </div>
          </div>
          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Proveedores ========== -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üì¶ Distribuci√≥n por proveedor</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="renderProvidersPanels()">‚Üª Actualizar</button>
          </div>
        </div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Compras ========== -->
    <section class="tab" id="tab-compras" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üõí Compras (por proveedor o sin asignar)</strong>
          <div class="toolbar">
            <button class="btn small" id="compras-add">+ A√±adir compra</button>
            <button class="btn small muted" id="compras-sync">‚òÅÔ∏è Sincronizar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">Registra lo que realmente se compr√≥. Esto alimenta el reparto. Solo los productos comprados aparecer√°n en Reparto.</div>
          <div id="compras-wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Reparto (optimizado por tienda) ========== -->
    <section class="tab" id="tab-reparto" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üöö Reparto (por tienda)</strong>
          <div class="toolbar seg">
            <button class="btn small" id="seg-sp" onclick="cambiarTiendaReparto('sp')">San Pablo</button>
            <button class="btn small" id="seg-sl" onclick="cambiarTiendaReparto('sl')">San Lesmes</button>
            <button class="btn small" id="seg-st" onclick="cambiarTiendaReparto('st')">Santiago</button>
            <button class="btn small" id="reparto-save">üíæ Guardar reparto</button>
          </div>
        </div>
        <div class="bd">
          <div id="reparto-wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Precios (independiente de proveedores) ========== -->
    <section class="tab" id="tab-precios" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üìä Precios (solo producto)</strong>
          <div class="toolbar">
            <button class="btn small muted" id="precios-save">üíæ Guardar (fila)</button>
            <button class="btn small" id="precios-send">üü¢ WhatsApp cambios</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">No se agrupa por proveedor. Gestiona <b>precio por producto</b>.</div>
          <div id="precios-wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>

    <!-- ========== TARJETA: Sincronizaci√≥n manual Supabase ========== -->
    <section>
      <div class="card">
        <div class="hd">
          <strong>‚òÅÔ∏è Sincronizaci√≥n manual (Supabase)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="syncPull()">‚¨áÔ∏è Cargar</button>
            <button class="btn" onclick="syncPush()">‚¨ÜÔ∏è Subir</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">Usa estos botones para sincronizar manualmente con Supabase (pull/push).</div>
        </div>
      </div>
    </section>

  </div> <!-- End .container -->

  <!-- Tabbar m√≥vil fija -->
  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">üìö<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">üè™<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">üßÆ<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">üì¶<span>Proveedores</span></button>
    <button id="btn-compras" onclick="showTab('compras')">üõí<span>Compras</span></button>
    <button id="btn-reparto" onclick="showTab('reparto')">üöö<span>Reparto</span></button>
    <button id="btn-precios" onclick="showTab('precios')">üìä<span>Precios</span></button>
  </nav>
  <!-- üîΩ AQUI EMPIEZA EL JS (BLOQUE 3) -->
<script>
/* ==========================
   Tabs + Estado Global
========================== */
function showTab(key){
  const ids = ['dic','tiendas','global','proveedores','compras','reparto','precios'];
  ids.forEach(k=>{
    const sec=document.getElementById('tab-'+k);
    const btn=document.getElementById('btn-'+k);
    if(sec) sec.style.display=(k===key)?'block':'none';
    if(btn) btn.classList.toggle('active',k===key);
  });
  if(key==='global'){ unificarGlobal(); buildProvBar(); }
  if(key==='proveedores'){ renderProvidersPanels(); }
  if(key==='compras'){ renderCompras(); }
  if(key==='reparto'){ renderRepartoOptimizado(); }
  if(key==='precios'){ renderPreciosProducto(); }
  updateGlobalStatus();
}

/* ==========================
   Config + Utils
========================== */
const LS = {
  VOCAB:'arslan_v37_vocab',
  STORES:'arslan_v37_stores',
  ASSIGN:'arslan_v37_assign',
  ORDERS:'arslan_v37_orders',
  PURCHASES:'arslan_v37_purchases',
  REPARTO:'arslan_v37_reparto',
  PRICES:'arslan_v37_prices',
  SENT_LOG:'arslan_v37_sentlog'
};
const PROVEEDORES = ["ESMO","MONTENEGRO","√ÅNGEL VACA","JOS√â ANTONIO","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos'];

const $ = s=>document.querySelector(s);
const byId = id=>document.getElementById(id);
const toLines = t=>String(t||'').split(/[\n\r,]/).map(x=>x.trim()).filter(Boolean);

function cleanNum(n,def=0){ const x=Number(String(n).replace(',','.')); if(!isFinite(x)||isNaN(x)) return def; return Math.max(0,x); }
function getSentLog(){ try{return JSON.parse(localStorage.getItem(LS.SENT_LOG)||'[]')||[];}catch{return[];} }
function pushSentLog(entry){ const log=getSentLog(); log.push(entry); localStorage.setItem(LS.SENT_LOG,JSON.stringify(log)); }
function todayISO(){ return new Date().toISOString().slice(0,10); }

function removeDiacriticsUpper(s){
  return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/√±/g,'N').replace(/√ë/g,'N').toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s).replace(/[^A-Z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
}
function stripGenericWords(s){
  const tokens = normKey(s).split(' ').filter(t=>!IGNORE_WORDS.includes(t.toLowerCase()));
  return tokens.join(' ').trim();
}

/* ==========================
   Vocabulario
========================== */
const OFFICIAL_VOCAB_RAW = `AGUACATE GRANEL
MANZANA GOLDEN 24
TOMATE DANIELA
ZANAHORIA
KIWI ZESPRI GOLD
PLATANO CANARIO PRIMERA
CEBOLLA NORMAL
PATATA LAVADA
PIMIENTO ITALIANO VERDE
TOMATE CHERRY RAMA
BROCOLI
PEPINO
NARANJA ZUMO
MANGO
FRESAS
TOMATE ROSA
TOMATE PERA
PIMIENTO ROJO
PIMIENTO VERDE
CEBOLLA ROJA
LIMON PRIMERA
LIMA
UVA ROJA
UVA BLANCA
SANDIA
MELON GALIA
LECHUGA ROMANA
APIO
PEREJIL
CILANTRO
ESPINACA
...`; // puedes pegar tu vocabulario completo

function uniqueVocab(lines){
  const seen=new Set(); const out=[];
  for(const l of lines){
    const t = removeDiacriticsUpper(l).trim(); if(!t) continue;
    const k = normKey(t); if(!seen.has(k)){ seen.add(k); out.push(t); }
  }
  return out;
}
function loadVocab(){
  const saved=localStorage.getItem(LS.VOCAB);
  const base=(saved&&saved.trim())?saved:OFFICIAL_VOCAB_RAW;
  const list=uniqueVocab(toLines(base));
  byId('vocabTxt').value=list.join('\n');
  return list;
}
function saveVocab(){ localStorage.setItem(LS.VOCAB, byId('vocabTxt').value||''); alert('Vocabulario guardado.'); renderProvidersPanels(); unificarGlobal(); updateGlobalStatus(); }
function addNewWord(){
  const entry=prompt("Introduce nuevo producto (uno por l√≠nea si son varios):");
  if(!entry) return;
  const current=toLines(byId('vocabTxt').value);
  const added=toLines(entry);
  const merged=uniqueVocab(current.concat(added));
  byId('vocabTxt').value=merged.join('\n');
  saveVocab();
}

/* ==========================
   Similitud / Parser
========================== */
function bigrams(str){ const s=stripGenericWords(str); const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); } return arr; }
function diceSim(a,b){ const A=bigrams(a),B=bigrams(b); if(!A.length||!B.length) return 0; let hits=0; const pool=B.slice(); A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} }); return (2*hits)/(A.length+B.length); }
function tokenSetSim(a,b){ const A=new Set(stripGenericWords(a).split(' ').filter(Boolean)); const B=new Set(stripGenericWords(b).split(' ').filter(Boolean)); if(!A.size||!B.size) return 0; let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; }); return inter/Math.max(A.size,B.size); }
function similarityScore(a,b){ return 0.7*diceSim(a,b)+0.3*tokenSetSim(a,b); }
function bestMatch(query,vocabArr){ const q=stripGenericWords(query); let best={name:null,score:0}; vocabArr.forEach(v=>{ const sc=similarityScore(q,v); if(sc>best.score) best={name:v,score:sc}; }); return best; }

function parseLine(raw){
  if(!raw) return null;
  let s=raw.replace(/\t/g,' ').replace(/\s{2,}/g,' ').trim();
  s=s.replace(/^[-‚Ä¢*]\s*/,'');
  let qty=null,name=s;
  const mX=s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/); if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }
  if(qty===null){ const mEnd=s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas)?\s*$/i); if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); } }
  if(qty===null){ const mStart=s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/); if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); } }
  if(qty===null){ qty=1; }
  name=stripGenericWords(name);
  return {original:removeDiacriticsUpper(s),name,qty};
}

/* ==========================
   Estado
========================== */
const tiendaState={sp:[],sl:[],st:[]}; // [{o,e,q,a}]
let globalRows=[];                      // [{name,total}]
let assignments={};                     // { normKey(name): proveedor }
let orders={};                          // { proveedor: [{name,qty}] }
let ACTIVE_PROV=PROVEEDORES[0];

let __purchases={};                     // { prov : [{name,purchased}] , "_SIN_PROV_": [...] }
let __reparto={};                       // { name : {sp,sl,st} }

// PRECIOS (independiente de proveedores)
function getPrices(){ try{ return JSON.parse(localStorage.getItem(LS.PRICES)||'{}')||{}; }catch{return{};} }
function setPrices(obj){ localStorage.setItem(LS.PRICES, JSON.stringify(obj||{})); }
function priceKey(name){ return normKey(name); }

/* ==========================
   Carga/persistencia
========================== */
function loadState(){
  try{ const s=JSON.parse(localStorage.getItem(LS.STORES)||'{}'); ['sp','sl','st'].forEach(k=>{ if(Array.isArray(s[k])) tiendaState[k]=s[k]; }); }catch{}
  try{ assignments=JSON.parse(localStorage.getItem(LS.ASSIGN)||'{}')||{}; }catch{}
  try{ orders=JSON.parse(localStorage.getItem(LS.ORDERS)||'{}')||{}; }catch{}
  try{ __purchases=JSON.parse(localStorage.getItem(LS.PURCHASES)||'{}')||{}; }catch{__purchases={};}
  try{ __reparto=JSON.parse(localStorage.getItem(LS.REPARTO)||'{}')||{}; }catch{__reparto={};}
  PROVEEDORES.forEach(p=>{ if(!Array.isArray(orders[p])) orders[p]=[]; });
}
function persistState(){
  localStorage.setItem(LS.STORES, JSON.stringify(tiendaState));
  localStorage.setItem(LS.ASSIGN, JSON.stringify(assignments));
  localStorage.setItem(LS.ORDERS, JSON.stringify(orders));
  localStorage.setItem(LS.PURCHASES, JSON.stringify(__purchases||{}));
  localStorage.setItem(LS.REPARTO, JSON.stringify(__reparto||{}));
  updateGlobalStatus();
}
function resetAll(){ if(confirm('¬øSeguro que quieres limpiar todo?')){ localStorage.clear(); location.reload(); } }
function resetAllButKeepVocab(){
  const vocab=localStorage.getItem(LS.VOCAB)||'';
  if(!confirm('¬øReiniciar todo manteniendo vocabulario?')) return;
  localStorage.clear(); localStorage.setItem(LS.VOCAB,vocab); alert('Reiniciado (vocab conservado).'); location.reload();
}

/* ==========================
   Autocomplete
========================== */
let AC_ACTIVE=null, AC_LISTENERS_ATTACHED=false;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; } }
function ensureACGlobalListeners(){
  if(AC_LISTENERS_ATTACHED) return;
  AC_LISTENERS_ATTACHED=true;
  ['click','scroll','resize','orientationchange'].forEach(ev=>{
    window.addEventListener(ev,(e)=>{ if(!AC_ACTIVE) return; if(ev==='click'){ if(e.target && AC_ACTIVE.contains(e.target)) return; } closeAC(); },{capture:true,passive:true});
  });
}
function positionACBoxForCell(box,cell){ const rect=cell.getBoundingClientRect(); box.style.left=(rect.left+window.scrollX)+'px'; box.style.top=(rect.bottom+window.scrollY)+'px'; box.style.width=rect.width+'px'; }
function attachAutocomplete(cell,onPick){
  ensureACGlobalListeners();
  const reposition=()=>{ if(AC_ACTIVE) positionACBoxForCell(AC_ACTIVE,cell); };
  cell.addEventListener('input',()=>{
    const val=stripGenericWords(cell.innerText||'').trim(); closeAC(); if(!val) return;
    const vocab=loadVocab();
    const suggestions=vocab.filter(v=>normKey(v).includes(normKey(val))).slice(0,8);
    if(!suggestions.length) return;
    const box=document.createElement('div'); box.className='ac-box';
    suggestions.forEach(s=>{ const item=document.createElement('div'); item.className='ac-item'; item.textContent=s; item.onclick=()=>{ onPick(s); closeAC(); }; box.appendChild(item); });
    document.body.appendChild(box); AC_ACTIVE=box; positionACBoxForCell(box,cell);
  });
  cell.addEventListener('keyup',()=>reposition());
}

/* ==========================
   Estandarizar por tienda + TXT/WhatsApp
========================== */
function renderTable(code){
  const wrap=byId('tbl_'+code+'_wrap'); const rows=tiendaState[code]||[]; if(!rows.length){ wrap.innerHTML=''; return; }
  let html='<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html+=`<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a?'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>${r.a?'<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html+='</tbody></table></div>'; wrap.innerHTML=html;
  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i=Number(cell.dataset.i); const f=cell.dataset.f;
    if(f==='e'){ attachAutocomplete(cell,(picked)=>{ cell.innerText=picked; tiendaState[code][i].e=picked; tiendaState[code][i].a=false; cell.classList.remove('red'); cell.parentElement.querySelector('td:last-child').innerHTML='<span class="pill ok">OK</span>'; persistState(); }); }
    cell.addEventListener('blur',()=>{
      const val=cell.innerText.trim();
      if(f==='q'){ tiendaState[code][i].q=cleanNum(val,0); }
      else{
        const cleaned=removeDiacriticsUpper(val); tiendaState[code][i].e=cleaned;
        const vocab=loadVocab(); const exact=vocab.find(v=>normKey(v)===normKey(cleaned));
        const tdState=cell.parentElement.querySelector('td:last-child');
        if(exact){ tiendaState[code][i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; }
        else { tiendaState[code][i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; }
      }
      persistState();
    });
  });
}
function estandarizar(code){
  const vocab=loadVocab(); const txt=byId('in_'+code).value; const rows=[];
  toLines(txt).forEach(line=>{
    const p=parseLine(line); if(!p) return;
    const exact=vocab.find(v=>normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original,e:exact,q:p.qty,a:false}); return; }
    const m=bestMatch(p.name,vocab); const chosen=m.name||p.name; rows.push({o:p.original,e:chosen,q:p.qty,a:(normKey(chosen)!==normKey(p.name))});
  });
  tiendaState[code]=rows; renderTable(code); persistState(); updateGlobalStatus();
}
function guardarTienda(code){
  const out=(tiendaState[code]||[]).map(r=>`${r.e} ${r.q}`).join('\n'); byId('in_'+code).value=out; alert(`Tienda ${code.toUpperCase()} guardada en el textarea.`);
}
function exportarTiendaTXT(code){
  const list=tiendaState[code]||[]; if(!list.length){ alert('No hay filas estandarizadas.'); return; }
  const today=new Date().toISOString().split('T')[0];
  const txt=list.map(r=>`${r.q}\t${r.e}`).join('\n');
  const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`tienda_${code}_${today}.txt`; a.click();
}
function whatsTienda(code){
  const list=tiendaState[code]||[]; if(!list.length){ alert('No hay filas estandarizadas.'); return; }
  let title = code==='sp'?'SAN PABLO':code==='sl'?'SAN LESMES':'SANTIAGO';
  const msg = `LISTA: ${title}\n` + list.map(r=>`- ${cleanNum(r.q,0)} ${r.e}`).join('\n');
  window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
}

/* ==========================
   Unificar global / Asignaci√≥n
========================== */
function unificarGlobal(){
  const all=[].concat(tiendaState.sp||[],tiendaState.sl||[],tiendaState.st||[]);
  const map=new Map(); all.forEach(r=>{ const k=normKey(r.e); if(!map.has(k)) map.set(k,{name:r.e,total:0}); map.get(k).total+=(Number(r.q)||0); });
  const arr=Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'es'));
  const names=arr.map(x=>x.name); const similarSet=new Set();
  for(let i=0;i<names.length;i++){ for(let j=i+1;j<names.length;j++){ const s1=names[i],s2=names[j]; const sc=similarityScore(s1,s2); if(sc>=0.86 && normKey(s1)!==normKey(s2)){ similarSet.add(s1); similarSet.add(s2); } } }
  renderGlobalTable(arr,similarSet); updateGlobalStatus();
}
function renderGlobalTable(rows,similarSet){
  const visible=rows.filter(r=>!assignments[normKey(r.name)]); globalRows=visible;
  const wrap=byId('global_wrap'); if(!visible.length){ wrap.innerHTML='<div class="hint">Sin productos (todo asignado o no unificado).</div>'; return; }
  let html=`<div class="hint" style="margin-bottom:6px">Proveedor activo: <b>${ACTIVE_PROV}</b>. Usa ‚úÖ para asignar.</div>
  <div class="scroll-x"><table><thead><tr><th></th><th>Producto</th><th>Total</th><th>Estado</th></tr></thead><tbody>`;
  visible.forEach((r,i)=>{
    const isSimilar=similarSet.has(r.name);
    html+=`<tr data-i="${i}" class="${isSimilar?'dup':''}">
      <td><button class="ok-assign" onclick="assignFromGlobal(${i})">‚úÖ</button></td>
      <td contenteditable="true" data-f="name">${r.name}${isSimilar?'<span class="flag">‚ö†Ô∏è</span>':''}</td>
      <td contenteditable="true" data-f="total">${r.total}</td>
      <td>${isSimilar?'<span class="pill warn">Posible duplicado</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html+='</tbody></table></div>'; wrap.innerHTML=html;
  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const tr=cell.parentElement; const idx=Number(tr.dataset.i); const f=cell.dataset.f;
    if(f==='name'){ attachAutocomplete(cell,(picked)=>{ cell.innerText=picked; globalRows[idx].name=picked; tr.classList.remove('dup'); tr.querySelector('td:last-child').innerHTML='<span class="pill ok">OK</span>'; }); }
    cell.addEventListener('blur',()=>{
      const val=cell.innerText.trim();
      if(f==='total'){ globalRows[idx].total=cleanNum(val,0); }
      else{
        const cleaned=removeDiacriticsUpper(val); globalRows[idx].name=cleaned;
        let dup=false; for(let k=0;k<globalRows.length;k++){ if(k===idx) continue; const sc=similarityScore(globalRows[idx].name,globalRows[k].name); if(sc>=0.86 && normKey(globalRows[idx].name)!==normKey(globalRows[k].name)){ dup=true; break; } }
        if(dup){ tr.classList.add('dup'); tr.querySelector('td:last-child').innerHTML='<span class="pill warn">Posible duplicado</span>'; }
        else{ tr.classList.remove('dup'); tr.querySelector('td:last-child').innerHTML='<span class="pill ok">OK</span>'; }
      }
    });
  });
}
function buildProvBar(){
  const bar=byId('provBar'); if(!bar) return; bar.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const b=document.createElement('button'); b.className='prov-btn'+(p===ACTIVE_PROV?' active':''); b.textContent=p;
    b.onclick=()=>{ ACTIVE_PROV=p; buildProvBar(); unificarGlobal(); };
    bar.appendChild(b);
  });
}
function assignFromGlobal(idx){
  const item=globalRows[idx]; if(!item) return;
  const k=normKey(item.name); assignments[k]=ACTIVE_PROV;
  const list=orders[ACTIVE_PROV]||[]; const exIdx=list.findIndex(x=>normKey(x.name)===k);
  if(exIdx>-1){ list[exIdx].qty+=Number(item.total)||0; } else { list.push({name:item.name,qty:Number(item.total)||0}); }
  orders[ACTIVE_PROV]=list; persistState(); unificarGlobal(); renderProvidersPanels(); updateGlobalStatus();
}

/* ==========================
   Proveedores
========================== */
let __lastClearedOrders=null;
function showUndoToast(){
  const t=document.createElement('div');
  t.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:70px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:10000;box-shadow:0 4px 14px rgba(0,0,0,.2);';
  t.innerHTML='Pedidos vaciados tras enviar. <button id="undoBtn" style="margin-left:8px;background:#fff;color:#111827;border:0;border-radius:6px;padding:6px 10px;cursor:pointer">Deshacer</button>';
  document.body.appendChild(t);
  document.getElementById('undoBtn').onclick=()=>{
    if(__lastClearedOrders){ const {prov,list}=__lastClearedOrders; orders[prov]=list; __lastClearedOrders=null; persistState(); renderProvidersPanels(); unificarGlobal(); updateGlobalStatus(); }
    t.remove();
  };
  setTimeout(()=>{ if(t.parentNode) t.remove(); },9000);
}
function getPedidoTexto(prov){
  const list=(orders?.[prov]||[]); if(!list.length) return '';
  let out=`PEDIDO ${prov}\n`; list.forEach(it=>{ out+=`- ${cleanNum(it.qty,0)} ${it.name}\n`; }); return out.trim();
}
function marcarCompradoTotalDeProveedor(prov,vaciarDespues=true){
  if(!Array.isArray(__purchases[prov])) __purchases[prov]=[];
  (orders?.[prov]||[]).forEach(it=>{
    const idx=__purchases[prov].findIndex(x=>normKey(x.name)===normKey(it.name));
    if(idx>-1) __purchases[prov][idx].purchased=cleanNum(it.qty,0);
    else __purchases[prov].push({name:it.name,purchased:cleanNum(it.qty,0)});
  });
  if(vaciarDespues){ __lastClearedOrders={prov,list:(orders[prov]||[]).map(x=>({...x}))}; orders[prov]=[]; showUndoToast(); }
  persistState(); renderProvidersPanels(); if(byId('btn-compras')?.classList.contains('active')) renderCompras(); if(byId('btn-reparto')?.classList.contains('active')) renderRepartoOptimizado(); alert(`Pedido de ${prov} marcado como COMPRADO y retirado del panel.`);
}
function renderProvidersPanels(){
  const cont=byId('provPanels'); if(!cont) return; cont.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const list=orders[p]||[];
    const card=document.createElement('div'); card.className='card';
    const hd=document.createElement('div'); hd.className='hd';
    hd.innerHTML=`<strong>${p}</strong>
      <div class="toolbar">
        <button class="btn small whats">üü¢ WhatsApp</button>
        <button class="btn small muted txtprov">üìÑ TXT + comprado</button>
      </div>`;
    const bd=document.createElement('div'); bd.className='bd';

    if(!list.length){
      bd.innerHTML='<div class="hint">Sin productos asignados a este proveedor.</div>';
    }else{
      let html='<div class="scroll-x"><table><thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody>';
      list.forEach((it,ix)=>{
        html+=`<tr>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="name" class="green">${it.name}</td>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="qty" class="green">${it.qty}</td>
        </tr>`;
      });
      html+='</tbody></table></div>'; bd.innerHTML=html;

      bd.querySelectorAll('td[contenteditable]').forEach(cell=>{
        const prov=cell.dataset.prov; const idx=Number(cell.dataset.idx); const f=cell.dataset.f;
        if(f==='name'){ attachAutocomplete(cell,(picked)=>{ cell.innerText=picked; orders[prov][idx].name=picked; persistState(); }); }
        cell.addEventListener('blur',()=>{ const val=cell.innerText.trim(); if(f==='qty'){ orders[prov][idx].qty=cleanNum(val,0); } else { orders[prov][idx].name=removeDiacriticsUpper(val); } persistState(); });
      });
    }

    card.appendChild(hd); card.appendChild(bd); cont.appendChild(card);

    const btnWhats=hd.querySelector('.btn.whats');
    if(btnWhats){
      btnWhats.onclick=()=>{
        const txt=getPedidoTexto(p); if(!txt){ alert('Sin l√≠neas para enviar.'); return; }
        pushSentLog({prov:p,when:todayISO(),type:'whatsapp',lines:(orders[p]||[]).length});
        window.open('https://wa.me/?text='+encodeURIComponent(txt),'_blank');
        marcarCompradoTotalDeProveedor(p,true);
      };
    }
    const btnTxt=hd.querySelector('.btn.txtprov');
    if(btnTxt){
      btnTxt.onclick=()=>{
        const listNow=(orders[p]||[]); if(!listNow.length){ alert('No hay l√≠neas para '+p); return; }
        const today=new Date().toISOString().split('T')[0];
        const txt=listNow.map(x=>`${x.qty} ${x.name}`).join('\n');
        const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pedido_${p}_${today}.txt`; a.click();
        pushSentLog({prov:p,when:todayISO(),type:'txt',lines:(orders[p]||[]).length});
        marcarCompradoTotalDeProveedor(p,true);
      };
    }
  });
  updateGlobalStatus();
}

/* ==========================
   Export Global
========================== */
function copiarGlobal(){ if(!globalRows.length) return; const txt=globalRows.map(r=>`- ${r.total} ${r.name}`).join('\n'); navigator.clipboard.writeText(txt); alert('Lista global copiada.'); }
function exportarGlobalTXT(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today=new Date().toISOString().split('T')[0];
  const txt=globalRows.map(r=>`${r.total}\t${r.name}`).join('\n');
  const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lista_global_${today}.txt`; a.click();
}
function exportarGlobalXLSX(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today=new Date().toISOString().split('T')[0];
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet([['Producto','Total'],...globalRows.map(r=>[r.name,r.total])]);
  XLSX.utils.book_append_sheet(wb,ws,'Global'); XLSX.writeFile(wb,`lista_global_${today}.xlsx`);
}
function exportResumenGlobalTXT(){
  const all=[].concat(tiendaState.sp||[],tiendaState.sl||[],tiendaState.st||[]);
  const totalMap={}; all.forEach(r=>{ const k=normKey(r.e); if(!totalMap[k]) totalMap[k]={name:r.e,total:0}; totalMap[k].total+=(Number(r.q)||0); });
  const byProv={}; PROVEEDORES.forEach(p=>byProv[p]=[]); const unassigned=[];
  Object.values(totalMap).forEach(it=>{ const k=normKey(it.name); const prov=assignments[k]; if(prov && PROVEEDORES.includes(prov)) byProv[prov].push({name:it.name,qty:it.total}); else unassigned.push({name:it.name,qty:it.total}); });
  let out=`üì¶ PEDIDOS POR PROVEEDOR\n\n`; PROVEEDORES.forEach(p=>{ out+=`> ${p}:\n`; if(byProv[p].length){ byProv[p].sort((a,b)=>a.name.localeCompare(b.name,'es')); byProv[p].forEach(x=>{ out+=`- ${x.qty} ${x.name}\n`; }); } else { out+=`- (sin l√≠neas)\n`; } out+=`\n`; });
  out+=`üìå SIN PROVEEDOR ASIGNADO:\n`; if(unassigned.length){ unassigned.sort((a,b)=>a.name.localeCompare(b.name,'es')); unassigned.forEach(x=>{ out+=`- ${x.qty} ${x.name}\n`; }); } else { out+=`- (sin l√≠neas)\n`; }
  const today=new Date().toISOString().split('T')[0]; const blob=new Blob([out],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`resumen_pedidos_${today}.txt`; a.click();
}

/* ==========================
   Compras
========================== */
function renderCompras(){
  const cont=byId('compras-wrap'); if(!cont) return;
  const purchases=__purchases||{}; let html='<table><thead><tr><th>Proveedor</th><th>Producto</th><th>Comprado</th><th>Acciones</th></tr></thead><tbody>';
  const vendors=PROVEEDORES||[];
  vendors.forEach(p=>{
    const list=purchases[p]||[];
    if(!list.length){ html+=`<tr><td>${p}</td><td colspan="3" class="hint">Sin compras</td></tr>`; }
    else{
      list.forEach((it,ix)=>{
        html+=`<tr data-prov="${p}" data-idx="${ix}">
          <td>${p}</td>
          <td contenteditable="true" class="c-name">${it.name}</td>
          <td><input class="c-qty" type="number" min="0" step="0.01" value="${cleanNum(it.purchased,0)}" style="width:100px"></td>
          <td><button class="btn small muted c-save">Guardar</button><button class="btn small c-del">Eliminar</button></td>
        </tr>`;
      });
    }
  });
  html+='</tbody></table>';

  // Sin proveedor
  const sinProv=unassignedTotals();
  html+=`<div class="card" style="margin-top:10px"><div class="hd"><strong>üõí Sin proveedor asignado</strong></div><div class="bd">${
    sinProv.length? `<table><thead><tr><th>Producto</th><th>Solicitado</th><th>Comprado</th><th></th></tr></thead><tbody>${
      sinProv.map((it)=>`
        <tr data-sp-name="${it.name}">
          <td class="c-name" contenteditable="true">${it.name}</td>
          <td>${it.qty}</td>
          <td><input class="c-qty" type="number" min="0" step="0.01" value="0" style="width:110px"></td>
          <td><button class="btn small">Guardar</button></td>
        </tr>
      `).join('')
    }</tbody></table>` : `<div class="hint">No hay productos sin asignar.</div>`
  }</div></div>`;
  cont.innerHTML=html;

  cont.querySelectorAll('.c-save').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const tr=btn.closest('tr'); const p=tr.dataset.prov, ix=Number(tr.dataset.idx);
      const name=tr.querySelector('.c-name').innerText.trim(); const qty=cleanNum(tr.querySelector('.c-qty').value,0);
      __purchases[p][ix]={name,purchased:qty}; persistState(); renderCompras(); renderRepartoOptimizado();
    });
  });
  cont.querySelectorAll('.c-del').forEach(btn=>{
    btn.addEventListener('click',()=>{ const tr=btn.closest('tr'); const p=tr.dataset.prov, ix=Number(tr.dataset.idx); __purchases[p].splice(ix,1); persistState(); renderCompras(); renderRepartoOptimizado(); });
  });
  cont.querySelectorAll('tr[data-sp-name]').forEach(tr=>{
    const btn=tr.querySelector('.btn'); btn.addEventListener('click',()=>{
      const name=removeDiacriticsUpper(tr.querySelector('.c-name').innerText.trim()); const qty=cleanNum(tr.querySelector('.c-qty').value,0);
      if(!Array.isArray(__purchases['_SIN_PROV_'])) __purchases['_SIN_PROV_']=[];
      const idx=__purchases['_SIN_PROV_'].findIndex(x=>normKey(x.name)===normKey(name));
      if(idx>-1) __purchases['_SIN_PROV_'][idx].purchased=qty; else __purchases['_SIN_PROV_'].push({name,purchased:qty});
      persistState(); alert('Compra guardada sin proveedor.'); renderCompras(); renderRepartoOptimizado();
    });
  });

  byId('compras-add').onclick=()=>{
    const prov=prompt('Proveedor (exacto):\n'+(PROVEEDORES||[]).join(', ')); if(!prov) return;
    const name=prompt('Producto:'); if(!name) return;
    const qty=cleanNum(prompt('Cantidad comprada:')||'0',0);
    if(!__purchases[prov]) __purchases[prov]=[]; __purchases[prov].push({name:removeDiacriticsUpper(name),purchased:qty});
    persistState(); renderCompras(); renderRepartoOptimizado();
  };
  byId('compras-sync').onclick=()=>{ persistState(); alert('Sincronizado local.'); };

  updateGlobalStatus();
}
function totalSolicitadoPorNombre(){
  const all=[].concat(tiendaState.sp||[],tiendaState.sl||[],tiendaState.st||[]);
  const map={}; all.forEach(r=>{ const k=normKey(r.e); map[k]=(map[k]||0)+(Number(r.q)||0); });
  const byName={}; Object.keys(map).forEach(k=>{ const row=all.find(r=>normKey(r.e)===k); byName[row?row.e:k]=map[k]; });
  return byName;
}
function unassignedTotals(){
  const totals=totalSolicitadoPorNombre(); const out=[];
  Object.keys(totals).forEach(name=>{ const k=normKey(name); const prov=(assignments||{})[k]; if(!prov){ out.push({name,qty:Number(totals[name])||0}); } });
  out.sort((a,b)=>a.name.localeCompare(b.name,'es')); return out;
}
function solicitadoPorTienda(name){
  const nk=normKey(name); const S={sp:0,sl:0,st:0};
  (tiendaState?.sp||[]).forEach(r=>{ if(normKey(r.e)===nk) S.sp+=Number(r.q)||0; });
  (tiendaState?.sl||[]).forEach(r=>{ if(normKey(r.e)===nk) S.sl+=Number(r.q)||0; });
  (tiendaState?.st||[]).forEach(r=>{ if(normKey(r.e)===nk) S.st+=Number(r.q)||0; });
  return S;
}
function totalComprado(){
  const map={};
  (PROVEEDORES||[]).forEach(p=>{ (__purchases[p]||[]).forEach(it=>{ map[it.name]=(map[it.name]||0)+(Number(it.purchased)||0); }); });
  (__purchases['_SIN_PROV_']||[]).forEach(it=>{ map[it.name]=(map[it.name]||0)+(Number(it.purchased)||0); });
  return map;
}
function totalSolicitado(){
  const all=[].concat(tiendaState?.sp||[],tiendaState?.sl||[],tiendaState?.st||[]); const map={};
  all.forEach(r=>{ const k=normKey(r.e); map[k]=(map[k]||0)+(Number(r.q)||0); });
  const byName={}; Object.keys(map).forEach(k=>{ const row=all.find(r=>normKey(r.e)===k); byName[row?row.e:k]=map[k]; });
  return byName;
}
function autoExceso(sol,comp){ const ex=Math.max(0,comp-sol); return {sp:+(ex*0.50).toFixed(2), sl:+(ex*0.20).toFixed(2), st:+(ex*0.30).toFixed(2)}; }
function objetivoPorTienda(name){
  const comp=+(Number(totalComprado()[name])||0).toFixed(2);
  const base=solicitadoPorTienda(name);
  const totalBase=+(base.sp+base.sl+base.st).toFixed(2);
  const ex=autoExceso(totalBase,comp);
  return { sp:+(base.sp+ex.sp).toFixed(2), sl:+(base.sl+ex.sl).toFixed(2), st:+(base.st+ex.st).toFixed(2) };
}

/* ==========================
   Reparto Optimizado (por tienda)
========================== */
let repartoTiendaActiva='sp';
function cambiarTiendaReparto(t){
  repartoTiendaActiva=t;
  ['seg-sp','seg-sl','seg-st'].forEach(id=>byId(id)?.classList.remove('active'));
  byId('seg-'+t)?.classList.add('active');
  renderRepartoOptimizado();
}

function renderRepartoOptimizado(){
  const cont=byId('reparto-wrap'); if(!cont) return;
  const comprado=totalComprado(); const productos=Object.keys(comprado).sort((a,b)=>a.localeCompare(b,'es'));
  if(!productos.length){ cont.innerHTML='<div class="hint">No hay productos comprados todav√≠a.</div>'; updateGlobalStatus(); return; }

  const tienda=repartoTiendaActiva; let pendientes=[], entregados=[];
  productos.forEach(name=>{
    const comp=+(Number(comprado[name])||0).toFixed(2); if(comp<=0) return;
    const obj=objetivoPorTienda(name); const cur=__reparto[name]||{sp:0,sl:0,st:0};
    const entregado=+(cur[tienda]||0).toFixed(2); const objetivo=+(obj[tienda]||0).toFixed(2);
    const totalEntregado=+((cur.sp||0)+(cur.sl||0)+(cur.st||0)).toFixed(2);
    const restGlobal=Math.max(0, +(comp-totalEntregado).toFixed(2));
    const pendiente=Math.max(0, +(objetivo-entregado).toFixed(2));
    if(pendiente>0 && restGlobal>0) pendientes.push({name,entregado,objetivo});
    else entregados.push({name,entregado,objetivo});
  });

  // Orden: pendientes arriba, entregados abajo
  let html='<div class="scroll-x">';
  html+='<h4>Pendientes</h4>';
  if(!pendientes.length) html+='<div class="hint">Nada pendiente en esta tienda.</div>';
  else{
    html+='<table><thead><tr><th>Producto</th><th>Entregado</th><th>Objetivo</th><th>Acci√≥n</th></tr></thead><tbody>';
    pendientes.forEach(({name,entregado,objetivo})=>{
      html+=`<tr data-name="${name}">
        <td>${name}</td>
        <td>${entregado}</td>
        <td>${objetivo}</td>
        <td>
          <div class="seg">
            <button class="btn small muted" onclick="incReparto('${name}',1)">+1</button>
            <button class="btn small muted" onclick="incReparto('${name}',5)">+5</button>
            <button class="btn small muted" onclick="incReparto('${name}',10)">+10</button>
            <button class="btn small" onclick="completarRepartoTienda('${name}')">‚úÖ Completar</button>
          </div>
        </td>
      </tr>`;
    });
    html+='</tbody></table>';
  }

  html+='<h4 style="margin-top:14px">Entregados</h4>';
  if(!entregados.length) html+='<div class="hint">A√∫n no hay productos completados para esta tienda.</div>';
  else{
    html+='<table><thead><tr><th>Producto</th><th>Entregado</th><th>Objetivo</th></tr></thead><tbody>';
    entregados.forEach(({name,entregado,objetivo})=>{
      html+=`<tr><td>${name}</td><td>${entregado}</td><td>${objetivo}</td></tr>`;
    });
    html+='</tbody></table>';
  }
  html+='</div>';
  cont.innerHTML=html;

  byId('reparto-save').onclick=()=>{ persistState(); alert('Reparto guardado.'); };

  updateGlobalStatus();
}
function incReparto(name,step){
  const tienda=repartoTiendaActiva;
  const comp=+(Number(totalComprado()[name])||0).toFixed(2);
  const obj=objetivoPorTienda(name);
  const cur=__reparto[name]||{sp:0,sl:0,st:0};
  const totalEntregado=+((cur.sp||0)+(cur.sl||0)+(cur.st||0)).toFixed(2);
  const restGlobal=Math.max(0, +(comp-totalEntregado).toFixed(2));
  const pendienteTienda=Math.max(0, +((obj[tienda]||0)-(cur[tienda]||0)).toFixed(2));
  if(restGlobal<=0 || pendienteTienda<=0) return;
  const inc=Math.min(step, pendienteTienda, restGlobal);
  __reparto[name]={...cur,[tienda]:+(((cur[tienda]||0)+inc).toFixed(2))};
  persistState(); renderRepartoOptimizado();
}
function completarRepartoTienda(name){
  const tienda=repartoTiendaActiva;
  const obj=objetivoPorTienda(name); const cur=__reparto[name]||{sp:0,sl:0,st:0};
  const objetivo=+(obj[tienda]||0).toFixed(2); const entregado=+(cur[tienda]||0).toFixed(2);
  const inc=Math.max(0, +(objetivo-entregado).toFixed(2));
  if(inc>0){ incReparto(name,inc); } else { renderRepartoOptimizado(); }
}

/* ==========================
   Precios (solo producto)
========================== */
function productosParaPrecios(){
  // productos que aparecen en solicitados o comprados
  const set=new Set();
  Object.keys(totalSolicitado()).forEach(n=>set.add(n));
  Object.keys(totalComprado()).forEach(n=>set.add(n));
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'es'));
}
function renderPreciosProducto(){
  const cont=byId('precios-wrap'); if(!cont) return;
  const prices=getPrices(); const prods=productosParaPrecios();
  if(!prods.length){ cont.innerHTML='<div class="hint">No hay productos para gestionar precios a√∫n.</div>'; return; }
  let html='<table><thead><tr><th>Producto</th><th>Precio anterior</th><th>Precio nuevo</th><th>Acci√≥n</th></tr></thead><tbody>';
  prods.forEach(name=>{
    const k=priceKey(name); const prev=(k in prices)? prices[k] : null;
    html+=`<tr data-name="${name}">
      <td>${name}</td>
      <td>${prev!==null? prev : '<span class="hint">‚Äî</span>'}</td>
      <td><input class="p-new" type="number" min="0" step="0.01" value="${prev!==null?prev:''}" style="width:130px"></td>
      <td class="seg">
        <button class="btn small muted p-save">Guardar</button>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  cont.innerHTML=html;

  cont.querySelectorAll('.p-save').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const tr=btn.closest('tr'); const name=tr.dataset.name;
      const val=tr.querySelector('.p-new').value; if(val===''){ alert('Introduce un precio.'); return; }
      const price=Number(val); if(!isFinite(price)){ alert('Precio inv√°lido.'); return; }
      const p=getPrices(); p[priceKey(name)]=price; setPrices(p); tr.style.background='#f6ffed'; updateGlobalStatus();
    });
  });

  byId('precios-save').onclick=()=>{ alert('Cada fila se guarda con su bot√≥n "Guardar".'); };
  byId('precios-send').onclick=()=>{
    const p=getPrices(); const cambios=[];
    cont.querySelectorAll('tr[data-name]').forEach(tr=>{
      const name=tr.dataset.name; const val=tr.querySelector('.p-new').value;
      if(val==='') return; const price=Number(val); const k=priceKey(name);
      if(!(k in p) || Number(p[k])!==price){ cambios.push({name,prev:p[k]??null,next:price}); p[k]=price; }
    });
    setPrices(p);
    if(!cambios.length){ alert('No hay cambios de precio para enviar.'); return; }
    const msg = 'CAMBIOS DE PRECIOS\n' + cambios.map(r=>`- ${r.name}: ${(r.prev??'‚Äî')} ‚Üí ${r.next}`).join('\n');
    window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
    updateGlobalStatus();
  };
}

/* ==========================
   Estado Global
========================== */
function updateGlobalStatus(){
  const all=[].concat(tiendaState.sp||[],tiendaState.sl||[],tiendaState.st||[]);
  const totalMap={}; all.forEach(r=>{ const k=normKey(r.e); if(!totalMap[k]) totalMap[k]={name:r.e,total:0}; totalMap[k].total+=(Number(r.q)||0); });
  const unassignedKeys=Object.keys(totalMap).filter(k=>!assignments[k]); const sinAsignar=unassignedKeys.length;

  const sentToday=getSentLog().filter(x=>x.when===todayISO()); const pedidosEnviados=sentToday.length;

  let compradosUds=0; Object.values(__purchases||{}).forEach(list=>{ (list||[]).forEach(it=>compradosUds+=(Number(it.purchased)||0)); });

  let lineasOrders=0; Object.values(orders||{}).forEach(list=>lineasOrders+=(list||[]).length);
  let lineasCompradas=0; Object.values(__purchases||{}).forEach(list=>lineasCompradas+=(list||[]).filter(it=>(Number(it.purchased)||0)>0).length);
  const sinComprar=Math.max(0,lineasOrders-lineasCompradas);

  let pendienteReparto=0; const compradoPorNombre=totalComprado();
  Object.keys(compradoPorNombre).forEach(name=>{
    const entreg = __reparto[name]? ((Number(__reparto[name].sp||0)+Number(__reparto[name].sl||0)+Number(__reparto[name].st||0))):0;
    const rest = Math.max(0, Number(compradoPorNombre[name]) - entreg); pendienteReparto += rest;
  });

  // Cambios de precio: cualquier producto listado que no tenga precio guardado
  const pricesObj=getPrices();
  let cambiosPrecio=0; productosParaPrecios().forEach(name=>{ if(!(priceKey(name) in pricesObj)) cambiosPrecio++; });

  byId('status-assign').textContent=`üßæ Sin asignar: ${sinAsignar}`;
  byId('status-buy').textContent=`üõí Sin comprar: ${sinComprar}`;
  byId('status-sent').textContent=`‚úÖ Pedidos enviados: ${pedidosEnviados}`;
  byId('status-bought').textContent=`üì¶ Comprados: ${compradosUds} uds`;
  byId('status-distribute').textContent=`üöö Reparto pendiente: ${pendienteReparto}`;
  byId('status-prices').textContent=`üìä Cambios precio: ${cambiosPrecio}`;
}

/* ==========================
   INIT
========================== */
(function init(){
  showTab('dic'); loadVocab(); loadState();
  ['sp','sl','st'].forEach(code=>renderTable(code));
  buildProvBar(); renderProvidersPanels(); unificarGlobal(); updateGlobalStatus();
  cambiarTiendaReparto('sp');
})();
</script>
<script>
// ===== Supabase Credenciales (las tuyas) =====
const SUPA_URL = "https://esvfgvfqttvjcrsnxufq.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzdmZndmZxdHR2amNyc254dWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNTIwNjIsImV4cCI6MjA3NzgyODA2Mn0.SdtgaK6c7gJAxA8jH77w0K3ctMlvGx6g4YLYrI0PKuw";
const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

// ===== PULL: cargar desde supabase ‚Üí local =====
async function syncPull(){
  try{
    const tables=['vocab','tienda_sp','tienda_sl','tienda_st','assignments','orders','purchases','reparto','prices','sent_log'];
    const res = {};
    for(const t of tables){
      const { data, error } = await supa.from(t).select('*');
      if(error) throw error;
      res[t]=data||[];
    }

    // Volcar datos
    if(res.vocab?.length){ const list=res.vocab.sort((a,b)=>(a.id||0)-(b.id||0)).map(r=>r.palabra); localStorage.setItem(LS.VOCAB, list.join('\n')); }

    // Tiendas
    tiendaState.sp = (res.tienda_sp||[]).map(r=>({o:r.o,e:r.e,q:Number(r.q)||0,a:!!r.a}));
    tiendaState.sl = (res.tienda_sl||[]).map(r=>({o:r.o,e:r.e,q:Number(r.q)||0,a:!!r.a}));
    tiendaState.st = (res.tienda_st||[]).map(r=>({o:r.o,e:r.e,q:Number(r.q)||0,a:!!r.a}));

    // Assignments
    assignments = {}; (res.assignments||[]).forEach(r=>{ assignments[r.producto]=r.proveedor; });

    // Orders
    orders = {}; PROVEEDORES.forEach(p=>orders[p]=[]);
    (res.orders||[]).forEach(r=>{ if(!orders[r.proveedor]) orders[r.proveedor]=[]; orders[r.proveedor].push({name:r.name,qty:Number(r.qty)||0}); });

    // Purchases
    __purchases = {};
    (res.purchases||[]).forEach(r=>{ if(!__purchases[r.proveedor]) __purchases[r.proveedor]=[]; __purchases[r.proveedor].push({name:r.name,purchased:Number(r.purchased)||0}); });

    // Reparto
    __reparto = {}; (res.reparto||[]).forEach(r=>{ __reparto[r.producto]={sp:Number(r.sp)||0,sl:Number(r.sl)||0,st:Number(r.st)||0}; });

    // Prices (producto ‚Üí precio)
    const pricesObj={}; (res.prices||[]).forEach(r=>{ pricesObj[priceKey(r.name)]=Number(r.price); });
    setPrices(pricesObj);

    // Sent log
    const sent = (res.sent_log||[]).map(r=>({prov:r.prov,when:r.when,type:r.type,lines:Number(r.lines)||0}));
    localStorage.setItem(LS.SENT_LOG, JSON.stringify(sent));

    // Re-render
    persistState();
    ['sp','sl','st'].forEach(code=>renderTable(code));
    renderProvidersPanels(); unificarGlobal(); renderCompras(); renderRepartoOptimizado(); renderPreciosProducto();
    alert('Cargado desde Supabase.');
  }catch(e){ console.warn(e); alert('Error al cargar desde Supabase. Revisa las tablas/columnas.'); }
}

// ===== PUSH: subir local ‚Üí supabase (upsert) =====
async function syncPush(){
  try{
    // Vocab
    await supa.from('vocab').upsert(toLines(byId('vocabTxt').value).map((v,i)=>({id:i+1,palabra:v})));
    // Tiendas
    await supa.from('tienda_sp').upsert((tiendaState.sp||[]).map((r,i)=>({id:i+1,o:r.o,e:r.e,q:r.q,a:r.a})));
    await supa.from('tienda_sl').upsert((tiendaState.sl||[]).map((r,i)=>({id:i+1,o:r.o,e:r.e,q:r.q,a:r.a})));
    await supa.from('tienda_st').upsert((tiendaState.st||[]).map((r,i)=>({id:i+1,o:r.o,e:r.e,q:r.q,a:r.a})));
    // Assignments
    await supa.from('assignments').upsert(Object.entries(assignments).map(([k,v])=>({producto:k,proveedor:v})));
    // Orders
    await supa.from('orders').upsert(Object.entries(orders).flatMap(([p,list])=> (list||[]).map((item,i)=>({id:`${p}-${i}`,proveedor:p,name:item.name,qty:item.qty}))));
    // Purchases
    await supa.from('purchases').upsert(Object.entries(__purchases).flatMap(([p,list])=> (list||[]).map((item,i)=>({id:`${p}-${i}`,proveedor:p,name:item.name,purchased:item.purchased}))));
    // Reparto
    await supa.from('reparto').upsert(Object.entries(__reparto).map(([name,dist])=>({producto:name,sp:dist.sp||0,sl:dist.sl||0,st:dist.st||0})));
    // Prices
    const pricesArray = Object.entries(getPrices()).map(([k,price],i)=>({id:i+1,name:k,price:price}));
    await supa.from('prices').upsert(pricesArray);
    // Sent Log
    const sentLog = getSentLog().map((x,i)=>({id:i+1,prov:x.prov,when:x.when,type:x.type,lines:x.lines}));
    await supa.from('sent_log').upsert(sentLog);

    alert('Subido a Supabase.');
  }catch(e){ console.warn(e); alert('Error al subir a Supabase.'); }
}
</script>
/* RESET & BASE */
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  font-size: 14px;
  color: var(--ink);
  background: var(--bg);
  line-height: 1.4;
}
h1, h2, h3, h4 {
  margin: 0;
  font-weight: 600;
}

/* CARD */
.card {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 12px;
  overflow: hidden;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.card .hd {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}
.card .bd {
  padding: 12px;
}

/* BUTTONS */
.btn {
  border: none;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 6px;
  background: var(--kiwi);
  color: white;
  font-weight: 500;
  font-size: 13px;
  transition: background 0.2s;
}
.btn:hover {
  background: var(--kiwi-2);
}
.btn.small {
  padding: 4px 8px;
  font-size: 12px;
}
.btn.ghost {
  background: transparent;
  color: var(--kiwi-2);
  border: 1px solid var(--kiwi-2);
}
.btn.ghost:hover {
  background: var(--kiwi-2);
  color: white;
}
.btn.muted {
  background: var(--muted);
}
.btn.muted:hover {
  background: #4b5563;
}

/* TOOLBAR */
.toolbar {
  display: flex;
  gap: 6px;
  align-items: center;
}
.toolbar.seg .btn {
  border-radius: 0;
}
.toolbar.seg .btn:first-child {
  border-radius: 6px 0 0 6px;
}
.toolbar.seg .btn:last-child {
  border-radius: 0 6px 6px 0;
}

/* TABLES */
table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}
th, td {
  border: 1px solid var(--border);
  padding: 5px 6px;
  text-align: left;
  vertical-align: middle;
}
th {
  background: var(--panel);
  font-weight: 600;
}
tr.dup {
  background: #fff7ed;
}
tr.dup td {
  border-color: #fed7aa;
}
td.green {
  background: #f6ffed;
}
td.red {
  background: #fff1f2;
}

/* TEXTAREA */
textarea {
  width: 100%;
  min-height: 120px;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 8px;
  font-size: 13px;
  font-family: 'Poppins', sans-serif;
  resize: vertical;
}

/* SCROLLABLE */
.scroll-x {
  overflow-x: auto;
}
.scroll-y {
  overflow-y: auto;
  max-height: 300px;
}

/* NOTAS Y PASTILLAS */
.hint {
  font-size: 12px;
  color: var(--muted);
}
.pill {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  display: inline-block;
  color: white;
}
.pill.ok {
  background: var(--ok);
}
.pill.bad {
  background: var(--bad);
}
.pill.warn {
  background: var(--warn);
}

/* STICKY TABBAR */
.tabbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #111827;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 6px 0;
  z-index: 999;
}
.tabbar button {
  background: none;
  border: none;
  color: #9ca3af;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  font-size: 13px;
  cursor: pointer;
  padding: 4px 0;
}
.tabbar button span {
  font-size: 11px;
}
.tabbar button.active {
  color: white;
}
.tabbar button.active::after {
  content: '';
  width: 6px;
  height: 6px;
  background: var(--kiwi);
  border-radius: 50%;
  margin-top: 2px;
}

/* PROV-BAR */
.prov-bar {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 4px;
}
.prov-btn {
  border: 1px solid var(--border);
  background: #f3f4f6;
  padding: 4px 10px;
  border-radius: 18px;
  cursor: pointer;
  font-size: 12px;
}
.prov-btn.active {
  border-color: var(--kiwi);
  background: #dcfce7;
  font-weight: 600;
}

/* FLAGS */
.flag {
  color: var(--warn);
  font-size: 12px;
  margin-left: 4px;
}

/* INPUT TYPES */
input[type="number"] {
  padding: 4px 6px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 13px;
  background: white;
}

/* AUTOCOMPLETE BOX */
.ac-box {
  position: absolute;
  z-index: 9999;
  background: white;
  border: 1px solid var(--border);
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  max-height: 200px;
  overflow-y: auto;
}
.ac-item {
  padding: 6px 10px;
  cursor: pointer;
}
.ac-item:hover {
  background: #e5e7eb;
}

/* RESPONSIVE CARDS COLUMN */
.grid-3 {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
  gap: 10px;
}

/* HIDDEN DUPLICATES */
.ok-assign {
  background: var(--kiwi);
  color: white;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  padding: 0 6px;
  font-size: 14px;
}
.ok-assign:hover {
  background: var(--kiwi-2);
}

/* SMALL MOBILE */
@media (max-width: 600px) {
  .tabbar span {
    display: none;
  }
  table {
    font-size: 12px;
  }
}
