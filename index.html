<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.5 ‚Äî KIWI MOBILE + ESTADO GLOBAL</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --ink: #111827;
    --muted: #6b7280;
    --kiwi: #16a34a;
    --kiwi-2: #15803d;
    --border: #e5e7eb;
    --panel: #f8fafc;
    --bad: #dc2626;
    --ok: #16a34a;
    --warn: #f59e0b;
    --bg: #ffffff;
  }
  * { box-sizing: border-box; }
  body { font-family: 'Poppins', sans-serif; color: var(--ink); background: #fff; margin: 0; }
  h1 { font-size: 18px; margin: 0; color: var(--ink); }
  .container { padding: 12px 12px 76px; }
  .hint { font-size: 12px; color: var(--muted); }
  .card {
    border: 1px solid var(--border);
    border-radius: 14px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,.06);
    margin-bottom: 12px;
  }
  .card .hd {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 12px; border-bottom: 1px solid var(--border);
  }
  .card .bd { padding: 10px 12px; }
  .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn {
    padding: 8px 12px; border-radius: 10px; border: 1px solid var(--kiwi);
    background: linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%);
    color: #fff; cursor: pointer; font-size: 14px;
  }
  .btn.ghost { background: #fff; color: var(--kiwi); border: 1px solid var(--kiwi); }
  .btn.muted { background: #fff; border: 1px solid var(--border); color: var(--ink); }
  .btn.small { padding: 6px 10px; font-size: 13px; }
  textarea {
    width: 100%; min-height: 120px; border: 1px solid var(--border);
    border-radius: 12px; padding: 10px; resize: vertical; font-size: 14px;
  }
  table { width: 100%; border-collapse: collapse; }
  th,td { border-bottom: 1px solid var(--border); padding: 8px; text-align: left; font-size: 14px; vertical-align: top; }
  th { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .04em; }
  .scroll-x { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .pill {
    padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border);
    background: var(--panel); font-size: 12px; color: var(--muted); white-space: nowrap;
  }
  .pill.ok { border-color: #bbf7d0; background: #ecfdf5; color: #166534; }
  .pill.warn { border-color: #fecaca; background: #fee2e2; color: #991b1b; }
  .red { color: var(--bad); font-weight: 700; }
  .green { color: var(--ok); font-weight: 700; }
  .ac-box {
    position: absolute; background: #fff; border: 1px solid var(--border);
    border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,.08);
    z-index: 9999; overflow: hidden; max-height: 220px; overflow-y: auto;
  }
  .ac-item { padding: 8px 10px; cursor: pointer; font-size: 14px; }
  .ac-item:hover { background: #f3f4f6; }
  .prov-bar { display: flex; gap: 8px; flex-wrap: wrap; }
  .prov-btn {
    padding: 8px 12px; border-radius: 999px; border: 1px solid var(--kiwi);
    background: #fff; color: var(--kiwi); cursor: pointer; font-size: 13px;
  }
  .prov-btn.active { background: var(--kiwi); color: #fff; }
  .ok-assign {
    border: 1px solid var(--kiwi); background: #ecfdf5; color: #166534;
    border-radius: 10px; padding: 6px 10px; cursor: pointer;
  }
  .dup { background: #fff5f5; }
  .dup .flag { color: #b91c1c; font-weight: 700; margin-left: 6px; }
  /* Tabbar m√≥vil fija */
  .tabbar {
    position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid var(--border);
    display: flex; justify-content: space-around; align-items: center; height: 56px; z-index: 999;
  }
  .tabbar button { background: #fff; border: none; color: var(--muted); font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
  .tabbar button.active { color: var(--kiwi); }
  .grid-3 { display: grid; grid-template-columns: 1fr; gap: 12px; }
  @media(min-width:980px){ .grid-3 { grid-template-columns: repeat(3,1fr); } }
  /* ===== Estado global superior ===== */
  #global-status {
    padding: 12px; margin: 8px 0 14px; background: var(--panel); border: 1px solid var(--border);
    border-radius: 12px; font-size: 13px; line-height: 1.4;
  }
  #global-status strong { font-size: 13px; display: block; margin-bottom: 4px; }
</style>
</head>

<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h1>üçà ARSLAN LISTAS v3.5 ‚Äî KIWI MOBILE TABS + ESTADO GLOBAL</h1>
      <span class="pill">Modo m√≥vil optimizado</span>
    </div>

    <!-- ======= Estado Global Superior ======= -->
    <div id="global-status">
      <strong>üìä ESTADO GLOBAL DEL SISTEMA</strong>
      <span id="status-assign">üßæ Sin asignar: 0</span> &nbsp;&nbsp;
      <span id="status-buy">üõí Sin comprar: 0</span> &nbsp;&nbsp;
      <span id="status-sent">‚úÖ Pedidos enviados: 0</span><br>
      <span id="status-bought">üì¶ Comprados: 0 uds</span> &nbsp;&nbsp;
      <span id="status-distribute">üöö Reparto pendiente: 0</span> &nbsp;&nbsp;
      <span id="status-prices">üìä Cambios precio: 0</span>
    </div>

    <div class="hint" style="margin-bottom:10px">Flujo: Diccionario ‚Üí Tiendas (Estandarizar/Exportar) ‚Üí Global (Unificar/Asignar) ‚Üí Proveedores (TXT/WhatsApp) ‚Üí Compras/Reparto ‚Üí Precios</div>
    <!-- ========== TAB: Diccionario ========== -->
    <section class="tab" id="tab-dic">
      <div class="card">
        <div class="hd">
          <strong>üìö Vocabulario estandarizado (editable)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
            <button class="btn ghost" onclick="saveVocab()">Guardar vocabulario</button>
            <button class="btn muted" onclick="resetAll()">üßπ Limpiar todo</button>
            <button class="btn muted" onclick="resetAllButKeepVocab()">‚ôªÔ∏è Reiniciar todo (mantener vocab)</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:6px">Un producto por l√≠nea. Se normaliza a <b>MAY√öSCULAS</b> sin tildes. Sin duplicados.</div>
          <textarea id="vocabTxt"></textarea>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Tiendas ========== -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <!-- San Pablo -->
        <div class="card">
          <div class="hd"><strong>üè™ San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sp')">Guardar tienda</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">üìÑ TXT</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo...&#10;Ej.: 3 cajas tomate daniela&#10;zanahoria 2&#10;aguacate granel 4"></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir.</div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
        <!-- San Lesmes -->
        <div class="card">
          <div class="hd"><strong>üè™ San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sl')">Guardar tienda</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">üìÑ TXT</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir.</div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
        <!-- Santiago -->
        <div class="card">
          <div class="hd"><strong>üè™ Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('st')">Guardar tienda</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">üìÑ TXT</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir.</div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Global ========== -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd"><strong>üßÆ Unificaci√≥n global</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal()">Unificar 3 tiendas</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">üìÑ TXT Global (asignados + pendientes)</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            ‚úÖ a la izquierda asigna al proveedor activo.
            Duplicados probables se <span class="red">marcan en rojo</span> y fila rosada (<b>‚ö†Ô∏è</b>).
          </div>
          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="hint">Proveedor activo:</span>
                <div class="prov-bar" id="provBar"></div>
              </div>
            </div>
          </div>
          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Proveedores ========== -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd"><strong>üì¶ Distribuci√≥n por proveedor</strong></div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Compras ========== -->
    <section class="tab" id="tab-compras" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üõí Compras (por proveedor o sin asignar)</strong>
          <div class="toolbar">
            <button class="btn small" id="compras-add">+ A√±adir compra</button>
            <button class="btn small muted" id="compras-sync">‚òÅÔ∏è Sincronizar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">Registra lo que realmente se compr√≥. Esto alimenta el reparto. Solo los productos comprados aparecer√°n en Reparto.</div>
          <div id="compras-wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Reparto ========== -->
    <section class="tab" id="tab-reparto" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üöö Reparto (solo productos COMPRADOS)</strong>
          <div class="toolbar">
            <button class="btn small" id="reparto-save">üíæ Guardar reparto</button>
          </div>
        </div>
        <div class="bd">
          <div id="reparto-wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Precios ========== -->
    <section class="tab" id="tab-precios" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üìä Precios (por proveedor)</strong>
          <div class="toolbar">
            <button class="btn small" id="precios-send">‚úâÔ∏è Enviar cambios por WhatsApp</button>
            <button class="btn small muted" id="precios-save">üíæ Guardar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">Marca precios nuevos o pulsa <b>‚úÖ Igual</b> si no hay cambio. Los cambios se agrupan por proveedor para WhatsApp.</div>
          <div id="precios-wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>

  </div> <!-- End .container -->

  <!-- Tabbar m√≥vil -->
  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">üìö<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">üè™<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">üßÆ<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">üì¶<span>Proveedores</span></button>
    <button id="btn-compras" onclick="showTab('compras')">üõí<span>Compras</span></button>
    <button id="btn-reparto" onclick="showTab('reparto')">üöö<span>Reparto</span></button>
    <button id="btn-precios" onclick="showTab('precios')">üìä<span>Precios</span></button>
  </nav>
<script>
/* ==========================
   Tabs (m√≥vil) + Estado Global
========================== */
function showTab(key){
  const ids = ['dic','tiendas','global','proveedores','compras','reparto','precios'];
  ids.forEach(k=>{
    const sec = document.getElementById('tab-'+k);
    const btn = document.getElementById('btn-'+k);
    if(sec) sec.style.display = (k===key)?'block':'none';
    if(btn) btn.classList.toggle('active', k===key);
  });

  if(key==='global'){ unificarGlobal(); buildProvBar(); }
  if(key==='proveedores'){ renderProvidersPanels(); }
  if(key==='compras'){ renderCompras(); }
  if(key==='reparto'){ renderReparto(); }
  if(key==='precios'){ renderPrecios(); }

  updateGlobalStatus();
}

/* ==========================
   Configuraci√≥n y utilidades
========================== */
const LS = {
  VOCAB: 'arslan_v34_vocab',
  STORES: 'arslan_v34_stores',
  ASSIGN: 'arslan_v34_assign',
  ORDERS: 'arslan_v34_orders',
  PURCHASES: 'arslan_v34_purchases',
  REPARTO: 'arslan_v34_reparto',
  PRICES: 'arslan_v34_prices'
};

const PROVEEDORES = ["ESMO","MONTENEGRO","√ÅNGEL VACA","JOS√â ANTONIO","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos'];

const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const toLines = t => String(t||'').split(/[\n\r,]/).map(x=>x.trim()).filter(Boolean);

function removeDiacriticsUpper(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/√±/g,'N').replace(/√ë/g,'N')
    .toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s)
    .replace(/[^A-Z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function stripGenericWords(s){
  const tokens = normKey(s).split(' ').filter(t=>!IGNORE_WORDS.includes(t.toLowerCase()));
  return tokens.join(' ').trim();
}

/* ==========================
   Vocabulario (editable + persistente)
========================== */
const OFFICIAL_VOCAB_RAW = `GRANNY FRANCIA
MANZANA PINK LADY
MANDARINA COLOMBE
KIWI ZESPRI GOLD
PARAGUAYO 
KIWI TOMASIN PLANCHA
PERA RINCON DEL SOTO
MELOCOTON PRIMERA
AGUACATE GRANEL
MARACUYA
MANZANA GOLDEN 24
PLATANO CANARIO PRIMERA
MANDARINA HOJA
MANZANA GOLDEN 20
NARANJA TOMASIN
NECTARINA
NUECES
SANDIA
LIMON SEGUNDA
MANZANA FUJI
NARANJA MESA SONRISA
JENGIBRE
BATATA
AJO PRIMERA
CEBOLLA NORMAL
CALABAZA GRANDE
PATATA LAVADA
TOMATE CHERRY RAMA
TOMATE CHERRY PERA
TOMATE DANIELA
TOMATE ROSA PRIMERA
CEBOLLINO
TOMATE ASURCADO MARRON
TOMATE RAMA
PIMIENTO PADRON
ZANAHORIA
PEPINO
CEBOLLETA
PUERROS
BROCOLI
JUDIA VERDE
BERENJENA
PIMIENTO ITALIANO VERDE
PIMIENTO ITALIANO ROJO
CHAMPINON
UVA ROJA
UVA BLANCA
ALCACHOFA
CALABACIN
COLIFLOR
BATAVIA
ICEBERG
MANDARINA SEGUNDA
MANZANA GOLDEN 28
NARANJA ZUMO
KIWI SEGUNDA
MANZANA ROYAL GALA 24
PLATANO CANARIO SUELTO
CEREZA
FRESAS
ARANDANOS
ESPINACA
PEREJIL
CILANTRO
ACELGAS
PIMIENTO VERDE
PIMIENTO ROJO
MACHO VERDE
MACHO MADURO
YUCA
AVOCADO
CEBOLLA ROJA
MENTA
HABANERO
RABANITOS
POMELO
PAPAYA
REINETA 28
NISPERO
ALBARICOQUE
TOMATE PERA
TOMATE BOLA
TOMATE PINK
VALVENOSTA GOLDEN
MELOCOTON ROJO
MELON GALIA
APIO
NARANJA SANHUJA
LIMON PRIMERA
MANGO
MELOCOTON AMARILLO
VALVENOSTA ROJA
PINA
NARANJA HOJA
PERA CONFERENCIA SEGUNDA
CEBOLLA DULCE
TOMATE ASURCADO AZUL
ESPARRAGOS BLANCOS
ESPARRAGOS TRIGUEROS
REINETA PRIMERA
AGUACATE PRIMERA
COCO
NECTARINA SEGUNDA
REINETA 24
NECTARINA CARNE BLANCA
GUINDILLA
REINETA VERDE
PATATA 25KG
PATATA 5 KG
TOMATE RAFF
REPOLLO
KIWI ZESPRI
PARAGUAYO SEGUNDA
MELON
REINETA 26
TOMATE ROSA
MANZANA CRISPS
ALOE VERA PIEZAS
TOMATE ENSALADA
PATATA 10KG
MELON BOLLO
CIRUELA ROJA
LIMA
GUINEO VERDE
SETAS
BANANA
BONIATO
FRAMBUESA
BREVAS
PERA AGUA
YAUTIA
YAME
OKRA
MANZANA MELASSI
CACAHUETE
SANDIA NEGRA
SANDIA RAYADA
HIGOS
KUMATO
KIWI CHILE
MELOCOTON AMARILLO SEGUNDA
HIERBABUENA
REMOLACHA
LECHUGA ROMANA
KAKI
CIRUELA CLAUDIA
PERA LIMONERA
CIRUELA AMARILLA
HIGOS BLANCOS
UVA ALVILLO
LIMON EXTRA
PITAHAYA ROJA
HIGO CHUMBO
CLEMENTINA
GRANADA
NECTARINA PRIMERA BIS
CHIRIMOYA
UVA CHELVA
PIMIENTO CALIFORNIA VERDE
KIWI TOMASIN
PIMIENTO CALIFORNIA ROJO
MANDARINA SATSUMA
CASTANA
CAKI
MANZANA KANZI
PERA ERCOLINA
NABO
UVA ALVILLO NEGRA
CHAYOTE
ROYAL GALA 28
MANDARINA PRIMERA
PIMIENTO PINTON
MELOCOTON AMARILLO DE CALANDA
HINOJOS
MANDARINA DE HOJA
UVA ROJA PRIMERA
UVA BLANCA PRIMERA`;

function uniqueVocab(lines){
  const seen = new Set(); const out=[];
  for(const l of lines){
    const t = removeDiacriticsUpper(l).trim();
    if(!t) continue;
    const k = normKey(t);
    if(!seen.has(k)){ seen.add(k); out.push(t); }
  }
  return out;
}
function loadVocab(){
  const saved = localStorage.getItem(LS.VOCAB);
  const base = saved && saved.trim()? saved : OFFICIAL_VOCAB_RAW;
  const list = uniqueVocab(toLines(base));
  byId('vocabTxt').value = list.join('\n');
  return list;
}
function saveVocab(){
  localStorage.setItem(LS.VOCAB, byId('vocabTxt').value||'');
  alert('Vocabulario guardado.');
  renderProvidersPanels();
  unificarGlobal();
  updateGlobalStatus();
}
function addNewWord(){
  const entry = prompt("Introduce nuevo producto (uno por l√≠nea si son varios):");
  if(!entry) return;
  const current = toLines(byId('vocabTxt').value);
  const added = toLines(entry);
  const merged = uniqueVocab(current.concat(added));
  byId('vocabTxt').value = merged.join('\n');
  saveVocab();
}

/* ==========================
   Coincidencia aproximada (Dice + TokenSet)
========================== */
function bigrams(str){
  const s = stripGenericWords(str);
  const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); }
  return arr;
}
function diceSim(a,b){
  const A=bigrams(a), B=bigrams(b);
  if(!A.length||!B.length) return 0;
  let hits=0; const pool=B.slice();
  A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} });
  return (2*hits)/(A.length+B.length);
}
function tokenSetSim(a,b){
  const A=new Set(stripGenericWords(a).split(' ').filter(Boolean));
  const B=new Set(stripGenericWords(b).split(' ').filter(Boolean));
  if(!A.size||!B.size) return 0;
  let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
  return inter / Math.max(A.size,B.size);
}
function similarityScore(a,b){ return 0.7*diceSim(a,b) + 0.3*tokenSetSim(a,b); }
function bestMatch(query, vocabArr){
  const q = stripGenericWords(query);
  let best = {name:null, score:0};
  vocabArr.forEach(v=>{
    const sc = similarityScore(q, v);
    if(sc>best.score) best = {name:v, score:sc};
  });
  return best;
}

/* ==========================
   Parser l√≠neas (cantidad + nombre)
========================== */
function parseLine(raw){
  if(!raw) return null;
  let s = raw.replace(/\t/g,' ').replace(/\s{2,}/g,' ').trim();
  s = s.replace(/^[-‚Ä¢*]\s*/,'');
  let qty=null, name=s;

  const mX = s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/);
  if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }

  if(qty===null){
    const mEnd = s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas)?\s*$/i);
    if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); }
  }
  if(qty===null){
    const mStart = s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/);
    if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); }
  }
  if(qty===null){ qty=1; }

  name = stripGenericWords(name);
  return { original: removeDiacriticsUpper(s), name, qty };
}

/* ==========================
   Estado
========================== */
const tiendaState = { sp:[], sl:[], st:[] }; // [{o,e,q,a}]
let globalRows = [];                          // [{name,total}]
let assignments = {};                         // { normKey(name) : proveedor }
let orders = {};                              // { proveedor : [{name, qty}] }
let ACTIVE_PROV = PROVEEDORES[0];

// Compras y reparto (compartido con extensiones)
let __purchases = {};                         // { prov : [{name, purchased}] , "_SIN_PROV_": [...] }
let __reparto = {};                           // { name : {sp, sl, st} }

// Precios
function getPrices(){ try{ return JSON.parse(localStorage.getItem(LS.PRICES)||'{}')||{}; }catch{ return {}; } }
function setPrices(obj){ localStorage.setItem(LS.PRICES, JSON.stringify(obj||{})); }
function priceKey(prov,name){ return `${prov}||${normKey(name)}`; }

/* ==========================
   Carga y persistencia
========================== */
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS.STORES)||'{}');
    ['sp','sl','st'].forEach(k=>{ if(Array.isArray(s[k])) tiendaState[k]=s[k]; });
  }catch{}
  try{
    const a = JSON.parse(localStorage.getItem(LS.ASSIGN)||'{}');
    assignments = a||{};
  }catch{}
  try{
    const o = JSON.parse(localStorage.getItem(LS.ORDERS)||'{}');
    orders = o||{};
  }catch{}
  try{
    __purchases = JSON.parse(localStorage.getItem(LS.PURCHASES)||'{}')||{};
  }catch{ __purchases={}; }
  try{
    __reparto = JSON.parse(localStorage.getItem(LS.REPARTO)||'{}')||{};
  }catch{ __reparto={}; }

  PROVEEDORES.forEach(p=>{ if(!Array.isArray(orders[p])) orders[p]=[]; });
}
function persistState(){
  localStorage.setItem(LS.STORES, JSON.stringify(tiendaState));
  localStorage.setItem(LS.ASSIGN, JSON.stringify(assignments));
  localStorage.setItem(LS.ORDERS, JSON.stringify(orders));
  localStorage.setItem(LS.PURCHASES, JSON.stringify(__purchases||{}));
  localStorage.setItem(LS.REPARTO, JSON.stringify(__reparto||{}));
  updateGlobalStatus();
}
function resetAll(){
  if(confirm('¬øSeguro que quieres limpiar todo?')){ localStorage.clear(); location.reload(); }
}
function resetAllButKeepVocab(){
  const vocab = localStorage.getItem(LS.VOCAB) || '';
  if(!confirm('¬øSeguro que quieres reiniciar todo (manteniendo vocabulario)?')) return;
  localStorage.clear();
  localStorage.setItem(LS.VOCAB, vocab);
  alert('Reiniciado. El vocabulario se ha conservado.');
  location.reload();
}

/* ==========================
   Estandarizar por tienda
========================== */
let AC_ACTIVE = null;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; } }

function attachAutocomplete(cell, onPick){
  cell.addEventListener('input', ()=>{
    const val = stripGenericWords(cell.innerText||'');
    closeAC();
    if(!val) return;
    const vocab = loadVocab();
    const suggestions = vocab.filter(v=> normKey(v).includes(normKey(val))).slice(0,8);
    if(!suggestions.length) return;
    const rect = cell.getBoundingClientRect();
    const box = document.createElement('div');
    box.className='ac-box';
    box.style.left = (rect.left + window.scrollX) + 'px';
    box.style.top = (rect.bottom + window.scrollY) + 'px';
    box.style.width = rect.width + 'px';
    suggestions.forEach(s=>{
      const item = document.createElement('div');
      item.className='ac-item';
      item.textContent = s;
      item.onclick = ()=>{ onPick(s); closeAC(); };
      box.appendChild(item);
    });
    document.body.appendChild(box);
    AC_ACTIVE = box;
  });
  document.addEventListener('click', (e)=>{ if(AC_ACTIVE && !AC_ACTIVE.contains(e.target) && e.target!==cell){ closeAC(); }}, {capture:true});
}

function renderTable(code){
  const wrap = byId('tbl_'+code+'_wrap');
  const rows = tiendaState[code]||[];
  if(!rows.length){ wrap.innerHTML=''; return; }
  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>${r.a? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  // editable handlers + autocomplete
  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;
    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        tiendaState[code][i].e = picked;
        tiendaState[code][i].a = false;
        cell.classList.remove('red');
        cell.parentElement.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        persistState();
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='q'){
        tiendaState[code][i].q = Number(String(val).replace(',','.'))||0;
      }else{ // nombre
        const cleaned = removeDiacriticsUpper(val);
        tiendaState[code][i].e = cleaned;
        const vocab = loadVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        const tdState = cell.parentElement.querySelector('td:last-child');
        if(exact){ tiendaState[code][i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; }
        else { tiendaState[code][i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; }
      }
      persistState();
    });
  });
}

function estandarizar(code){
  const vocab = loadVocab();
  const txt = byId('in_'+code).value;
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const exact = vocab.find(v=> normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); return; }
    const m = bestMatch(p.name, vocab);
    const chosen = m.name || p.name;
    rows.push({o:p.original, e:chosen, q:p.qty, a:(normKey(chosen)!==normKey(p.name))});
  });
  tiendaState[code] = rows;
  renderTable(code);
  persistState();
  updateGlobalStatus();
}

function guardarTienda(code){
  const out = (tiendaState[code]||[]).map(r=> `${r.e} ${r.q}`).join('\n');
  byId('in_'+code).value = out;
  alert(`Tienda ${code.toUpperCase()} guardada en el textarea.`);
}

/* ==========================
   Unificar global + similares
========================== */
function unificarGlobal(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const map = new Map();
  all.forEach(r=>{
    const key = normKey(r.e);
    if(!map.has(key)) map.set(key,{name:r.e,total:0});
    map.get(key).total += (Number(r.q)||0);
  });
  const arr = Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  // detectar similares (score combinado)
  const names = arr.map(x=>x.name);
  const similarSet = new Set();
  for(let i=0;i<names.length;i++){
    for(let j=i+1;j<names.length;j++){
      const s1 = names[i], s2 = names[j];
      const sc = similarityScore(s1, s2);
      if(sc>=0.86 && normKey(s1)!==normKey(s2)){
        similarSet.add(s1); similarSet.add(s2);
      }
    }
  }
  renderGlobalTable(arr, similarSet);
  updateGlobalStatus();
}

/* ==========================
   GLOBAL + Asignaci√≥n a proveedor
========================== */
function renderGlobalTable(rows, similarSet){
  const visible = rows.filter(r => !assignments[normKey(r.name)]);
  globalRows = visible;

  const wrap = byId('global_wrap');
  if(!visible.length){ wrap.innerHTML='<div class="hint">Sin productos (todo asignado o no unificado).</div>'; return; }

  let html = `
    <div class="hint" style="margin-bottom:6px">
      Proveedor activo: <b>${ACTIVE_PROV}</b>. Usa ‚úÖ para asignar r√°pidamente.
    </div>
    <div class="scroll-x"><table>
      <thead><tr><th></th><th>Producto</th><th>Total</th><th>Estado</th></tr></thead>
      <tbody>`;
  visible.forEach((r,i)=>{
    const isSimilar = similarSet.has(r.name);
    html += `<tr data-i="${i}" class="${isSimilar?'dup':''}">
      <td><button class="ok-assign" onclick="assignFromGlobal(${i})">‚úÖ</button></td>
      <td contenteditable="true" data-f="name">${r.name}${isSimilar?'<span class="flag">‚ö†Ô∏è</span>':''}</td>
      <td contenteditable="true" data-f="total">${r.total}</td>
      <td>${isSimilar? '<span class="pill warn">Posible duplicado</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  // Edici√≥n inline + autocomplete
  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const tr = cell.parentElement;
    const idx = Number(tr.dataset.i);
    const f = cell.dataset.f;
    if(f==='name'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        globalRows[idx].name = picked;
        tr.classList.remove('dup');
        tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='total'){
        globalRows[idx].total = Number(String(val).replace(',','.'))||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        globalRows[idx].name = cleaned;
        const vocab = loadVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        if(exact){
          tr.classList.remove('dup');
          tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        }else{
          let dup = false;
          for(let k=0;k<globalRows.length;k++){
            if(k===idx) continue;
            const sc = similarityScore(globalRows[idx].name, globalRows[k].name);
            if(sc>=0.86 && normKey(globalRows[idx].name)!==normKey(globalRows[k].name)){ dup=true; break; }
          }
          if(dup){
            tr.classList.add('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill warn">Posible duplicado</span>';
          }else{
            tr.classList.remove('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill">OK</span>';
          }
        }
      }
    });
  });
}

function assignFromGlobal(idx){
  const item = globalRows[idx];
  if(!item) return;
  const k = normKey(item.name);
  assignments[k] = ACTIVE_PROV;

  const list = orders[ACTIVE_PROV]||[];
  const exIdx = list.findIndex(x=> normKey(x.name)===k);
  if(exIdx>-1){ list[exIdx].qty += Number(item.total)||0; }
  else{ list.push({name:item.name, qty:Number(item.total)||0}); }
  orders[ACTIVE_PROV] = list;

  persistState();
  unificarGlobal();
  renderProvidersPanels();
  updateGlobalStatus();
}

/* ==========================
   Barra de proveedores + paneles
========================== */
function buildProvBar(){
  const bar = byId('provBar'); if(!bar) return;
  bar.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const b = document.createElement('button');
    b.className = 'prov-btn' + (p===ACTIVE_PROV?' active':'');
    b.textContent = p;
    b.onclick = ()=>{
      ACTIVE_PROV = p;
      buildProvBar();
      unificarGlobal();
    };
    bar.appendChild(b);
  });
}

function renderProvidersPanels(){
  const cont = byId('provPanels'); if(!cont) return;
  cont.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const list = orders[p]||[];
    const card = document.createElement('div');
    card.className='card';
    const hd = document.createElement('div');
    hd.className='hd';
    hd.innerHTML = `<strong>${p}</strong>
      <div class="toolbar">
        <button class="btn small whats">üü¢ WhatsApp</button>
        <button class="btn small muted txtprov">üìÑ TXT + comprado</button>
      </div>`;
    const bd = document.createElement('div');
    bd.className='bd';

    if(!list.length){
      bd.innerHTML = '<div class="hint">Sin productos asignados.</div>';
    }else{
      let html = '<div class="scroll-x"><table><thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody>';
      list.forEach((it,ix)=>{
        html += `<tr>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="name" class="green">${it.name}</td>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="qty" class="green">${it.qty}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      bd.innerHTML = html;

      // edici√≥n inline en panel proveedor
      bd.querySelectorAll('td[contenteditable]').forEach(cell=>{
        const prov = cell.dataset.prov;
        const idx = Number(cell.dataset.idx);
        const f = cell.dataset.f;
        if(f==='name'){
          attachAutocomplete(cell, picked=>{
            cell.innerText = picked;
            orders[prov][idx].name = picked;
            persistState();
          });
        }
        cell.addEventListener('blur', ()=>{
          const val = cell.innerText.trim();
          if(f==='qty'){
            orders[prov][idx].qty = Number(String(val).replace(',','.'))||0;
          }else{
            orders[prov][idx].name = removeDiacriticsUpper(val);
          }
          persistState();
        });
      });
    }

    card.appendChild(hd); card.appendChild(bd);
    cont.appendChild(card);

    // Handlers de env√≠o que marcan comprado autom√°ticamente
    const btnWhats = hd.querySelector('.btn.whats');
    if(btnWhats){
      btnWhats.onclick = ()=>{
        const txt = getPedidoTexto(p);
        if(!txt){ alert('Sin l√≠neas para enviar.'); return; }
        const url = 'https://wa.me/?text=' + encodeURIComponent(txt);
        window.open(url, '_blank');
        marcarCompradoTotalDeProveedor(p, /*vaciar*/ true); // ahora vac√≠a tras marcar comprado
      };
    }
    const btnTxt = hd.querySelector('.btn.txtprov');
    if(btnTxt){
      btnTxt.onclick = ()=>{
        const listNow = (orders[p]||[]);
        if(!listNow.length){ alert('No hay l√≠neas para ' + p); return; }
        const today = new Date().toISOString().split('T')[0];
        const txt = listNow.map(x=> `${x.qty} ${x.name}`).join('\n');
        const blob = new Blob([txt],{type:'text/plain'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pedido_${p}_${today}.txt`; a.click();
        marcarCompradoTotalDeProveedor(p, /*vaciar*/ true); // ahora vac√≠a tras marcar comprado
      };
    }
  });
  updateGlobalStatus();
}

function getPedidoTexto(prov){
  const list = (orders?.[prov]||[]);
  if(!list.length) return '';
  let out = `PEDIDO ${prov}\n`;
  list.forEach(it=>{ out += `- ${Number(it.qty)||0} ${it.name}\n`; });
  return out.trim();
}

/* MODIFICADO: al marcar comprado, adem√°s de pasar a compras:
   - Vac√≠a las √≥rdenes del proveedor (para que desaparezcan del panel)
   - Recalcula reparto y refresca pesta√±as relacionadas */
function marcarCompradoTotalDeProveedor(prov, vaciarDespues = false){
  if(!Array.isArray(__purchases[prov])) __purchases[prov]=[];
  (orders?.[prov]||[]).forEach(it=>{
    const idx = __purchases[prov].findIndex(x=> normKey(x.name) === normKey(it.name));
    if (idx>-1) __purchases[prov][idx].purchased = Number(it.qty)||0;
    else __purchases[prov].push({name: it.name, purchased: Number(it.qty)||0});
  });

  if(vaciarDespues){
    orders[prov] = []; // üî• limpia la lista del proveedor
  }

  persistState();
  // refrescos contextuales
  renderProvidersPanels();
  if(byId('btn-compras')?.classList.contains('active')) renderCompras();
  if(byId('btn-reparto')?.classList.contains('active')) renderReparto();
  alert(`Pedido de ${prov} marcado como COMPRADO y retirado del panel de pedidos.`);
}

/* ==========================
   Exportaci√≥n Global
========================== */
function copiarGlobal(){
  if(!globalRows.length) return;
  const txt = globalRows.map(r=>`- ${r.total} ${r.name}`).join('\n');
  navigator.clipboard.writeText(txt);
  alert('Lista global copiada.');
}
function exportarGlobalTXT(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = globalRows.map(r=>`${r.total}\t${r.name}`).join('\n');
  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lista_global_${today}.txt`; a.click();
}
function exportarGlobalXLSX(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([['Producto','Total'], ...globalRows.map(r=>[r.name,r.total])]);
  XLSX.utils.book_append_sheet(wb, ws, 'Global');
  XLSX.writeFile(wb, `lista_global_${today}.xlsx`);
}

/* ==========================
   TXT Global (asignados + pendientes)
========================== */
function exportResumenGlobalTXT(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const totalMap = {};
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!totalMap[k]) totalMap[k] = {name:r.e, total:0};
    totalMap[k].total += (Number(r.q)||0);
  });

  const byProv = {}; PROVEEDORES.forEach(p=>byProv[p]=[]);
  const unassigned = [];
  Object.values(totalMap).forEach(it=>{
    const k = normKey(it.name);
    const prov = assignments[k];
    if(prov && PROVEEDORES.includes(prov)){
      byProv[prov].push({name:it.name, qty:it.total});
    }else{
      unassigned.push({name:it.name, qty:it.total});
    }
  });

  let out = `üì¶ PEDIDOS POR PROVEEDOR\n\n`;
  PROVEEDORES.forEach(p=>{
    out += `> ${p}:\n`;
    if(byProv[p].length){
      byProv[p].sort((a,b)=>a.name.localeCompare(b.name,'es'));
      byProv[p].forEach(x=>{ out += `- ${x.qty} ${x.name}\n`; });
    }else{
      out += `- (sin l√≠neas)\n`;
    }
    out += `\n`;
  });

  out += `üìå SIN PROVEEDOR ASIGNADO:\n`;
  if(unassigned.length){
    unassigned.sort((a,b)=>a.name.localeCompare(b.name,'es'));
    unassigned.forEach(x=>{ out += `- ${x.qty} ${x.name}\n`; });
  }else{
    out += `- (sin l√≠neas)\n`;
  }

  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([out],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`resumen_pedidos_${today}.txt`; a.click();
}

/* ==========================
   Compras
========================== */
function renderCompras(){
  const cont = byId('compras-wrap'); if(!cont) return;
  const purchases = __purchases || {};
  let html = '<table><thead><tr><th>Proveedor</th><th>Producto</th><th>Comprado</th><th>Acciones</th></tr></thead><tbody>';
  const vendors = PROVEEDORES||[];
  vendors.forEach(p=>{
    const list = purchases[p]||[];
    if(!list.length){
      html += `<tr><td>${p}</td><td colspan="3" class="hint">Sin compras</td></tr>`;
    }else{
      list.forEach((it,ix)=>{
        html += `<tr data-prov="${p}" data-idx="${ix}">
          <td>${p}</td>
          <td contenteditable="true" class="c-name">${it.name}</td>
          <td><input class="c-qty" type="number" min="0" step="0.01" value="${Number(it.purchased)||0}" style="width:100px"></td>
          <td>
            <button class="btn small muted c-save">Guardar</button>
            <button class="btn small c-del">Eliminar</button>
          </td>
        </tr>`;
      });
    }
  });
  html += '</tbody></table>';

  // Panel sin proveedor
  const sinProv = unassignedTotals();
  html += `<div class="card" style="margin-top:10px">
    <div class="hd"><strong>üõí Sin proveedor asignado</strong></div>
    <div class="bd">${
      sinProv.length? `
      <table><thead><tr><th>Producto</th><th>Solicitado</th><th>Comprado</th><th></th></tr></thead><tbody>
        ${sinProv.map((it,ix)=>`
          <tr data-sp-name="${it.name}">
            <td class="c-name" contenteditable="true">${it.name}</td>
            <td>${it.qty}</td>
            <td><input class="c-qty" type="number" min="0" step="0.01" value="0" style="width:110px"></td>
            <td><button class="btn small">Guardar</button></td>
          </tr>
        `).join('')}
      </tbody></table>` : `<div class="hint">No hay productos sin asignar.</div>`
    }</div>
  </div>`;

  cont.innerHTML = html;

  // Handlers compras por proveedor
  cont.querySelectorAll('.c-save').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('tr');
      const p = tr.dataset.prov, ix = Number(tr.dataset.idx);
      const name = tr.querySelector('.c-name').innerText.trim();
      const qty  = Number(tr.querySelector('.c-qty').value)||0;
      __purchases[p][ix] = {name, purchased:qty};
      persistState();
      renderCompras();
      renderReparto(); // üîÑ recalcula reparto autom√°ticamente
    });
  });
  cont.querySelectorAll('.c-del').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('tr');
      const p = tr.dataset.prov, ix = Number(tr.dataset.idx);
      __purchases[p].splice(ix,1);
      persistState();
      renderCompras();
      renderReparto(); // üîÑ recalcula reparto autom√°ticamente
    });
  });

  // Guardar compras sin proveedor
  cont.querySelectorAll('tr[data-sp-name]').forEach(tr=>{
    const nameEl = tr.querySelector('.c-name');
    const qtyEl  = tr.querySelector('.c-qty');
    const btn    = tr.querySelector('.btn');
    btn.addEventListener('click', ()=>{
      const name = removeDiacriticsUpper(nameEl.innerText.trim());
      const qty  = Number(qtyEl.value)||0;
      if(!Array.isArray(__purchases['_SIN_PROV_'])) __purchases['_SIN_PROV_']=[];
      const idx = __purchases['_SIN_PROV_'].findIndex(x=> normKey(x.name)===normKey(name));
      if(idx>-1) __purchases['_SIN_PROV_'][idx].purchased = qty;
      else __purchases['_SIN_PROV_'].push({name, purchased:qty});
      persistState();
      alert('Compra guardada sin proveedor.');
      renderCompras();
      renderReparto(); // üîÑ recalcula reparto autom√°ticamente
    });
  });

  // Acciones barra
  byId('compras-add').onclick = ()=>{
    const prov = prompt('Proveedor (exacto como en la lista):\n' + (PROVEEDORES||[]).join(', '));
    if(!prov){return;}
    const name = prompt('Producto (usa nombres del diccionario si es posible):');
    if(!name){return;}
    const qty = Number(prompt('Cantidad comprada:')||'0')||0;
    if(!__purchases[prov]) __purchases[prov]=[];
    __purchases[prov].push({name:removeDiacriticsUpper(name), purchased:qty});
    persistState();
    renderCompras();
    renderReparto(); // üîÑ recalcula reparto autom√°ticamente
  };
  byId('compras-sync').onclick = ()=>{
    persistState();
    alert('Sincronizado.');
  };

  updateGlobalStatus();
}

function totalSolicitadoPorNombre(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const map = {};
  all.forEach(r=>{
    const k = normKey(r.e);
    map[k] = (map[k]||0) + (Number(r.q)||0);
  });
  const byName={};
  Object.keys(map).forEach(k=>{
    const row = all.find(r=>normKey(r.e)===k);
    byName[row?row.e:k] = map[k];
  });
  return byName;
}
function unassignedTotals(){
  const totals = totalSolicitadoPorNombre();
  const out = [];
  Object.keys(totals).forEach(name=>{
    const k = normKey(name);
    const prov = (assignments||{})[k];
    if(!prov){ out.push({name, qty: Number(totals[name])||0}); }
  });
  out.sort((a,b)=>a.name.localeCompare(b.name,'es'));
  return out;
}

/* ==========================
   Reparto (NUEVO comportamiento)
========================== */
function solicitadoPorTienda(name){
  const nk = normKey(name);
  const S = {sp:0, sl:0, st:0};
  (tiendaState?.sp||[]).forEach(r=>{ if(normKey(r.e)===nk) S.sp += Number(r.q)||0; });
  (tiendaState?.sl||[]).forEach(r=>{ if(normKey(r.e)===nk) S.sl += Number(r.q)||0; });
  (tiendaState?.st||[]).forEach(r=>{ if(normKey(r.e)===nk) S.st += Number(r.q)||0; });
  return S;
}
function totalComprado(){
  const map={};
  (PROVEEDORES||[]).forEach(p=>{
    (__purchases[p]||[]).forEach(it=>{
      map[it.name] = (map[it.name]||0) + (Number(it.purchased)||0);
    });
  });
  // incluir _SIN_PROV_
  (__purchases['_SIN_PROV_']||[]).forEach(it=>{
    map[it.name] = (map[it.name]||0) + (Number(it.purchased)||0);
  });
  return map;
}
function totalSolicitado(){
  const all = [].concat(tiendaState?.sp||[], tiendaState?.sl||[], tiendaState?.st||[]);
  const map = {};
  all.forEach(r=>{
    const k = normKey(r.e);
    map[k] = (map[k]||0) + (Number(r.q)||0);
  });
  const byName={};
  Object.keys(map).forEach(k=>{
    const row = all.find(r=>normKey(r.e)===k);
    byName[row?row.e:k] = map[k];
  });
  return byName;
}

/* Reparte el exceso (si lo hay) 50/20/30 */
function autoExceso(sol, comp){
  const ex = Math.max(0, comp - sol);
  return {sp: +(ex*0.50).toFixed(2), sl: +(ex*0.20).toFixed(2), st: +(ex*0.30).toFixed(2)};
}

/* NUEVO: render Reparto con:
   - Solo bajar pendientes (bot√≥n ‚Äì)
   - Objetivo = solicitado por tienda + exceso 50/20/30
   - No supera comprado total ni objetivo por tienda
   - Completados desaparecen */
function renderReparto(){
  const cont = byId('reparto-wrap'); if(!cont) return;
  const rep = __reparto || {};
  const comprado = totalComprado();
  const solicitado = totalSolicitado();

  const productos = Object.keys(comprado).sort((a,b)=>a.localeCompare(b,'es'));
  if(!productos.length){ cont.innerHTML = '<div class="hint">No hay productos comprados todav√≠a.</div>'; updateGlobalStatus(); return;}

  let html = '<table><thead><tr><th>Producto</th><th>Comprado</th><th>Solicitado</th><th>Restante global</th><th>San Pablo (50%)</th><th>San Lesmes (20%)</th><th>Santiago (30%)</th><th></th></tr></thead><tbody>';

  productos.forEach(name=>{
    const comp = +(Number(comprado[name])||0).toFixed(2);
    const sol  = +(Number(solicitado[name])||0).toFixed(2);
    if(comp<=0) return;

    // Base: lo pedido por tienda
    const base = solicitadoPorTienda(name);
    const totalBase = +(base.sp + base.sl + base.st).toFixed(2);

    // Exceso comprado ‚Üí reparto autom√°tico 50/20/30
    const exceso = autoExceso(totalBase, comp);
    const objetivo = {
      sp: +(base.sp + exceso.sp).toFixed(2),
      sl: +(base.sl + exceso.sl).toFixed(2),
      st: +(base.st + exceso.st).toFixed(2)
    };

    const entregado = rep[name] || {sp:0, sl:0, st:0};

    // No permitir que lo entregado supere su objetivo
    const capEntregado = {
      sp: Math.min(entregado.sp||0, objetivo.sp),
      sl: Math.min(entregado.sl||0, objetivo.sl),
      st: Math.min(entregado.st||0, objetivo.st),
    };
    if(!rep[name]) rep[name] = {sp:0, sl:0, st:0};
    rep[name] = capEntregado; // sanea si crecieron objetivos hacia abajo

    // Restantes por tienda
    const pendiente = {
      sp: +(Math.max(0, objetivo.sp - capEntregado.sp)).toFixed(2),
      sl: +(Math.max(0, objetivo.sl - capEntregado.sl)).toFixed(2),
      st: +(Math.max(0, objetivo.st - capEntregado.st)).toFixed(2)
    };

    // Restante global = comprado - entregado total (capado a 0)
    const totalEntregado = +(capEntregado.sp + capEntregado.sl + capEntregado.st).toFixed(2);
    const restGlobal = Math.max(0, +(comp - totalEntregado).toFixed(2));

    // Si no queda nada por repartir o no queda stock, ocultar
    const pendienteTotal = +(pendiente.sp + pendiente.sl + pendiente.st).toFixed(2);
    if(pendienteTotal<=0 || restGlobal<=0){ return; }

    html += `<tr data-name="${name}">
      <td>${name}</td>
      <td>${comp}</td>
      <td>${sol}</td>
      <td>${restGlobal}</td>

      <td>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <button class="btn small muted r-dec" data-t="sp">‚Äì</button>
          <span class="pill">${capEntregado.sp} / ${objetivo.sp} (pend: ${pendiente.sp})</span>
        </div>
      </td>
      <td>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <button class="btn small muted r-dec" data-t="sl">‚Äì</button>
          <span class="pill">${capEntregado.sl} / ${objetivo.sl} (pend: ${pendiente.sl})</span>
        </div>
      </td>
      <td>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <button class="btn small muted r-dec" data-t="st">‚Äì</button>
          <span class="pill">${capEntregado.st} / ${objetivo.st} (pend: ${pendiente.st})</span>
        </div>
      </td>

      <td><button class="btn small" onclick="marcarTodoEntregado('${name}')">‚úÖ Completar</button></td>
    </tr>`;
  });

  html += '</tbody></table>';
  cont.innerHTML = html;

  // Handler: bot√≥n "‚Äì" reduce pendiente (aumenta entregado) sin pasar objetivos ni stock
  cont.querySelectorAll('.r-dec').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('tr');
      const name = tr.dataset.name;
      const tienda = btn.dataset.t;

      const comp = +(Number(totalComprado()[name])||0).toFixed(2);
      const base = solicitadoPorTienda(name);
      const totalBase = +(base.sp + base.sl + base.st).toFixed(2);
      const exceso = autoExceso(totalBase, comp);
      const objetivo = {
        sp: +(base.sp + exceso.sp).toFixed(2),
        sl: +(base.sl + exceso.sl).toFixed(2),
        st: +(base.st + exceso.st).toFixed(2)
      };

      const cur = __reparto[name] || {sp:0,sl:0,st:0};
      const totalEntregado = +( (cur.sp||0)+(cur.sl||0)+(cur.st||0) ).toFixed(2);
      const restGlobal = Math.max(0, +(comp - totalEntregado).toFixed(2));

      const pendienteTienda = Math.max(0, +(objetivo[tienda] - (cur[tienda]||0)).toFixed(2));

      if(restGlobal<=0 || pendienteTienda<=0){
        return; // nada que repartir
      }

      // incremento unitario (1) sin rebasar l√≠mites
      const inc = Math.min(1, pendienteTienda, restGlobal);
      __reparto[name] = {...cur, [tienda]: +( (cur[tienda]||0) + inc ).toFixed(2)};

      persistState();
      renderReparto();
    });
  });

  byId('reparto-save').onclick = ()=>{
    persistState();
    alert('Reparto guardado.');
  };

  updateGlobalStatus();
}

/* Completa reparto de un producto respetando l√≠mites y stock */
function marcarTodoEntregado(name){
  const comp = +(Number(totalComprado()[name])||0).toFixed(2);
  const base = solicitadoPorTienda(name);
  const totalBase = +(base.sp + base.sl + base.st).toFixed(2);
  const exceso = autoExceso(totalBase, comp);
  const objetivo = {
    sp: +(base.sp + exceso.sp).toFixed(2),
    sl: +(base.sl + exceso.sl).toFixed(2),
    st: +(base.st + exceso.st).toFixed(2)
  };

  const cur = __reparto[name] || {sp:0,sl:0,st:0};
  let restGlobal = Math.max(0, +(comp - ((cur.sp||0)+(cur.sl||0)+(cur.st||0))).toFixed(2));
  const out = {...cur};

  // Intentar cumplir objetivos en orden SP ‚Üí SL ‚Üí ST
  ['sp','sl','st'].forEach(t=>{
    const pend = Math.max(0, +(objetivo[t] - (out[t]||0)).toFixed(2));
    if(pend>0 && restGlobal>0){
      const inc = Math.min(pend, restGlobal);
      out[t] = +((out[t]||0) + inc).toFixed(2);
      restGlobal = +(restGlobal - inc).toFixed(2);
    }
  });

  __reparto[name] = out;
  persistState();
  renderReparto();
}

/* ==========================
   Precios (pesta√±a)
========================== */
function productosCompradosPorProveedor(){
  const out = {};
  (PROVEEDORES||[]).forEach(p=> out[p]=[]);
  // Del carrito de compras por proveedor
  const purchases = __purchases||{};
  Object.keys(purchases).forEach(prov=>{
    (purchases[prov]||[]).forEach(it=>{
      if(prov==='_SIN_PROV_') return; // omite sin proveedor en m√≥dulo de precios
      if((Number(it.purchased)||0)<=0) return;
      if(!out[prov]) out[prov]=[];
      const exists = out[prov].some(x=> normKey(x.name)===normKey(it.name));
      if(!exists) out[prov].push({name:it.name});
    });
  });
  return out;
}
function renderPrecios(){
  const cont = byId('precios-wrap'); if(!cont) return;
  const prices = getPrices();
  const data = productosCompradosPorProveedor();
  let html = '';
  const provs = Object.keys(data);
  if(!provs.length){ cont.innerHTML = '<div class="hint">No hay productos comprados todav√≠a.</div>'; return; }

  provs.forEach(prov=>{
    const list = data[prov]||[];
    html += `<div class="card" style="margin-bottom:10px">
      <div class="hd"><strong>${prov}</strong></div>
      <div class="bd">`;
    if(!list.length){
      html += `<div class="hint">Sin productos comprados para ${prov}.</div>`;
    }else{
      html += `<table><thead><tr><th>Producto</th><th>Precio anterior</th><th>Precio nuevo</th><th>Acci√≥n</th></tr></thead><tbody>`;
      list.sort((a,b)=>a.name.localeCompare(b.name,'es')).forEach((it)=>{
        const k = priceKey(prov, it.name);
        const prev = prices[k]?.price ?? '';
        html += `<tr data-prov="${prov}" data-name="${it.name}">
          <td>${it.name}</td>
          <td>${prev!==''? prev : '<span class="hint">‚Äî</span>'}</td>
          <td><input class="p-new" type="number" min="0" step="0.01" value="${prev!==''?prev:''}" style="width:130px"></td>
          <td>
            <button class="btn small muted p-save">Guardar</button>
            <button class="btn small p-equal">‚úÖ Igual</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
    }
    html += `</div></div>`;
  });
  cont.innerHTML = html;

  // Handlers
  cont.querySelectorAll('.p-save').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('tr');
      const prov = tr.dataset.prov;
      const name = tr.dataset.name;
      const val  = Number(tr.querySelector('.p-new').value);
      const k = priceKey(prov, name);
      const obj = getPrices();
      obj[k] = {prov, name, price: isFinite(val)? val : null};
      setPrices(obj);
      alert('Precio guardado.');
      updateGlobalStatus();
    });
  });
  cont.querySelectorAll('.p-equal').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('tr');
      const prov = tr.dataset.prov;
      const name = tr.dataset.name;
      const k = priceKey(prov, name);
      const obj = getPrices();
      if(obj[k] && obj[k].price!=null){
        tr.querySelector('.p-new').value = obj[k].price;
      }else{
        tr.querySelector('.p-new').value = '';
      }
      tr.style.background = '#f6ffed';
    });
  });

  // Barra superior de la pesta√±a
  byId('precios-save').onclick = ()=>{
    alert('Los cambios de precio por fila ya quedan guardados al pulsar "Guardar".');
  };
  byId('precios-send').onclick = ()=>{
    const obj = getPrices();
    const changesByProv = {};
    document.querySelectorAll('#precios-wrap tr[data-prov]').forEach(tr=>{
      const prov = tr.dataset.prov;
      const name = tr.dataset.name;
      const inputVal = tr.querySelector('.p-new').value;
      if(inputVal==='') return;
      const newPrice = Number(inputVal);
      if(!isFinite(newPrice)) return;

      const k = priceKey(prov, name);
      const prev = obj[k]?.price ?? null;

      if(prev===null || Number(prev) !== newPrice){
        if(!changesByProv[prov]) changesByProv[prov] = [];
        changesByProv[prov].push({name, prev, next:newPrice});
        obj[k] = {prov, name, price:newPrice};
      }
    });
    setPrices(obj);

    if(!Object.keys(changesByProv).length){
      alert('No hay cambios de precio para enviar.');
      return;
    }

    Object.keys(changesByProv).forEach(prov=>{
      const lines = changesByProv[prov].map(r=>{
        const prevTxt = (r.prev===null || r.prev===undefined || r.prev==='')? '‚Äî' : r.prev;
        return `- ${r.name}: ${prevTxt} ‚Üí ${r.next}`;
      }).join('\n');
      const msg = `CAMBIOS DE PRECIOS (${prov})\n${lines}`;
      const url = 'https://wa.me/?text=' + encodeURIComponent(msg);
      window.open(url, '_blank');
    });

    updateGlobalStatus();
  };
}

/* ==========================
   Estado Global Superior
========================== */
function updateGlobalStatus(){
  // Sin asignar (por nombre unificado)
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const totalMap = {};
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!totalMap[k]) totalMap[k] = {name:r.e, total:0};
    totalMap[k].total += (Number(r.q)||0);
  });
  const unassignedKeys = Object.keys(totalMap).filter(k=> !assignments[k]);
  const sinAsignar = unassignedKeys.length;

  // Pedidos enviados: consideramos proveedores con l√≠neas en orders
  const pedidosEnviados = Object.values(orders||{}).filter(list => list && list.length).length;

  // Comprados totales (uds)
  let compradosUds = 0;
  Object.values(__purchases||{}).forEach(list=>{
    (list||[]).forEach(it=> compradosUds += (Number(it.purchased)||0));
  });

  // Sin comprar: aproximaci√≥n = l√≠neas totales en orders - l√≠neas con purchased>0
  let lineasOrders = 0;
  Object.values(orders||{}).forEach(list=> lineasOrders += (list||[]).length);
  let lineasCompradas = 0;
  Object.values(__purchases||{}).forEach(list=> lineasCompradas += (list||[]).filter(it=> (Number(it.purchased)||0)>0).length);
  const sinComprar = Math.max(0, lineasOrders - lineasCompradas);

  // Reparto pendiente: suma de cantidades compradas menos entregadas
  let pendienteReparto = 0;
  const compradoPorNombre = totalComprado();
  Object.keys(compradoPorNombre).forEach(name=>{
    const entreg = __reparto[name] ? (Number(__reparto[name].sp||0)+Number(__reparto[name].sl||0)+Number(__reparto[name].st||0)) : 0;
    const rest = Math.max(0, Number(compradoPorNombre[name]) - entreg);
    pendienteReparto += rest;
  });

  // Cambios de precio por revisar
  const pricesObj = getPrices();
  let cambiosPrecio = 0;
  const compradosProv = productosCompradosPorProveedor();
  Object.keys(compradosProv).forEach(prov=>{
    compradosProv[prov].forEach(it=>{
      const k = priceKey(prov, it.name);
      if(!(k in pricesObj)) cambiosPrecio++;
    });
  });

  byId('status-assign').textContent = `üßæ Sin asignar: ${sinAsignar}`;
  byId('status-buy').textContent = `üõí Sin comprar: ${sinComprar}`;
  byId('status-sent').textContent = `‚úÖ Pedidos enviados: ${pedidosEnviados}`;
  byId('status-bought').textContent = `üì¶ Comprados: ${compradosUds} uds`;
  byId('status-distribute').textContent = `üöö Reparto pendiente: ${pendienteReparto}`;
  byId('status-prices').textContent = `üìä Cambios precio: ${cambiosPrecio}`;
}

/* ==========================
   INIT
========================== */
(function init(){
  showTab('dic');        // pesta√±a inicial
  loadVocab();           // carga vocab (o el guardado)
  loadState();           // tiendas + assignments + orders + compras + reparto
  ['sp','sl','st'].forEach(code=> renderTable(code));
  buildProvBar();
  renderProvidersPanels();
  unificarGlobal();      // pintar global inicial si hay datos
  updateGlobalStatus();
})();
</script>
<!-- ==========================
     Extensi√≥n opcional: Supabase sync
========================== -->
<script>
// Comprueba si Supabase est√° disponible
if (typeof window.supabase !== "undefined") {
  const SUPA_URL = localStorage.getItem("SUPA_URL");
  const SUPA_KEY = localStorage.getItem("SUPA_KEY");
  if (SUPA_URL && SUPA_KEY) {
    const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Funci√≥n para enviar estado a Supabase
    async function syncToSupabase() {
      try {
        await supa.from('vocab').upsert(
          toLines(byId('vocabTxt').value).map((v, i) => ({ id: i + 1, palabra: v }))
        );
        await supa.from('tienda_sp').upsert(tiendaState.sp.map((r, i) => ({ id: i + 1, ...r })));
        await supa.from('tienda_sl').upsert(tiendaState.sl.map((r, i) => ({ id: i + 1, ...r })));
        await supa.from('tienda_st').upsert(tiendaState.st.map((r, i) => ({ id: i + 1, ...r })));
        await supa.from('assignments').upsert(Object.entries(assignments).map(([k, v]) => ({ producto: k, proveedor: v })));
        await supa.from('orders').upsert(
          Object.entries(orders).flatMap(([p, list]) => list.map((item, i) => ({
            id: `${p}-${i}`, proveedor: p, ...item
          })))
        );
        await supa.from('purchases').upsert(
          Object.entries(__purchases).flatMap(([p, list]) => list.map((item, i) => ({
            id: `${p}-${i}`, proveedor: p, ...item
          })))
        );
        await supa.from('reparto').upsert(
          Object.entries(__reparto).map(([name, dist]) => ({
            producto: name, ...dist
          }))
        );
        await supa.from('prices').upsert(
          Object.values(getPrices()).map((pr, i) => ({
            id: i + 1, ...pr
          }))
        );
        alert("Sincronizado con Supabase correctamente.");
      } catch (e) {
        console.warn("Error en sincronizaci√≥n:", e);
        alert("Hubo un problema al sincronizar con Supabase.");
      }
    }

    // Bot√≥n de sincronizaci√≥n global (opcional)
    const syncBtn = document.createElement("button");
    syncBtn.className = "btn small muted";
    syncBtn.textContent = "‚òÅÔ∏è Sincronizar Supabase";
    syncBtn.style.marginTop = "10px";
    syncBtn.onclick = syncToSupabase;
    document.querySelector(".container").appendChild(syncBtn);
  }
}
</script>

</body>
</html>
